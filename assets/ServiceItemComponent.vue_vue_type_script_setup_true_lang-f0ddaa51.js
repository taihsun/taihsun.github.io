import{d as H,a6 as me,o as r,f as v,h as a,a1 as ue,j as h,k as ve,a_ as pe,D as _e,aZ as he,r as u,c as B,a as be,a4 as Y,e as _,B as z,y as X,g as e,w as I,z as R,i as g,v as D,F as T,x as E,t as x,E as Z,l as ge,ad as ye}from"./index-501cd1c4.js";import{G as fe,S as Se}from"./ServiceItemService-a5b6ed95.js";import{u as Ce}from"./FormSchemaStore-f2d56775.js";import{a as Ie}from"./SampleCategory-297f54b4.js";const xe=H({__name:"AppSelectUser",props:{name:{},options:{default:()=>[]}},setup(A){const p=A,{value:i,errorMessage:M,handleBlur:l,handleChange:N}=me(()=>p.name,void 0),U=n=>{N(n.map(c=>c.value))};return(n,c)=>(r(),v("div",null,[a(h(pe),ue({class:["form-control",{"is-invalid":h(M)?"is-invalid":""}],options:n.options,placeholder:"請選擇",label:"name",reduce:m=>m.id,onBlur:h(l),"onOption:selected":U},n.$attrs,{modelValue:h(i),"onUpdate:modelValue":c[0]||(c[0]=m=>ve(i)?i.value=m:null),multiple:""}),null,16,["class","options","reduce","onBlur","modelValue"])]))}});class y{static instance;api;constructor(p){this.api=p}static getInstance(){return y.instance||(y.instance=new y(fe)),y.instance}async fetchUsersByLabType(p){return await this.api.apiFetchUsersByLabType(p)}}const we={class:"row mb-2"},ke=e("label",{for:"labType",class:"col-sm-2 col-form-label red-star"},"單位 ",-1),Fe={class:"col-sm-4"},Be={class:"row mb-2"},Te=e("label",{for:"code",class:"col-sm-2 col-form-label red-star"},"Service Item Code ",-1),Ae={class:"col-sm-4"},Me={class:"row mb-2"},Ne=e("label",{for:"name",class:"col-sm-2 col-form-label red-star"},"Service Item Name ",-1),Ue={class:"col-sm-9"},Ve={class:"row mb-2"},Le=e("label",{for:"note",class:"col-sm-2 col-form-label"},"Note",-1),je={class:"col-sm-9"},Re={class:"row mb-2"},De=e("label",{for:"type",class:"col-sm-2 col-form-label red-star"},"服務項目類別",-1),Ee={class:"col-sm-4",id:"type"},Oe={class:"input-group"},Pe=e("label",{class:"input-group-text",for:"serviceCategory"},"大類",-1),$e={class:"col-sm-4"},qe={class:"input-group"},Ye=e("label",{class:"input-group-text",for:"serviceSubCategory"},"小類",-1),ze={class:"row mb-2"},Xe=e("label",{for:"owner",class:"col-sm-2 col-form-label red-star"},"負責人",-1),Ze={class:"col-sm-9"},He={class:"row mb-2"},Je=e("label",{for:"firstItemUnit",class:"col-sm-2 col-form-label red-star"},"Sample amount 之單位 ",-1),Ke={class:"col-3"},Qe={class:"col-3"},We={class:"row mb-2"},Ge=e("label",{for:"sampleCategory",class:"col-sm-2 col-form-label red-star"},"樣本種類",-1),et={class:"col-sm-8"},tt={class:"row mb-2"},st=e("label",{for:"externalCharge",class:"col-sm-2 col-form-label"},"外界單位收費(產)",-1),at={class:"col-sm-9"},ot={class:"row mb-2"},lt=e("label",{for:"exchangeRate",class:"col-sm-2 col-form-label"},"匯率",-1),nt={class:"col-sm-9"},ct={class:"row mb-2"},it=e("label",{for:"academicServiceItemFee",class:"col-sm-2 col-form-label red-star"},"學術費用",-1),rt={class:"col-sm-4"},dt={class:"row mb-2"},mt=e("label",{for:"industryServiceItemFee",class:"col-sm-2 col-form-label red-star"},"產業界費用",-1),ut={class:"col-sm-4"},vt={class:"row mb-2"},pt=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star"},"是否允許扣除餘額",-1),_t={class:"col-sm-9"},ht={class:"row mb-2"},bt=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star","red-star":""},"是否可自行填寫金額",-1),gt={class:"col-sm-9"},yt={class:"d-flex justify-content-between"},ft=e("button",{type:"button",class:"btn btn-primary","data-bs-toggle":"modal","data-bs-target":"#modalCenter"}," 設定儀器 ",-1),St={class:"table table-borderless"},Ct={class:"mt-2 d-flex justify-content-between flex-row-reverse"},It=["disabled"],xt={key:0,type:"button",class:"btn btn-danger mx-1","data-bs-toggle":"modal","data-bs-target":"#exampleModal"},wt={class:"modal fade",id:"modalCenter",tabindex:"-1","aria-hidden":"true"},kt={class:"modal-dialog modal-dialog-centered",role:"document"},Ft={class:"modal-content"},Bt=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"modalCenterTitle"},"選擇儀器"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1),Tt={class:"modal-body"},At={class:"input-group my-2"},Mt=e("span",{class:"input-group-text",id:"basic-addon1"},"Search",-1),Nt={class:"list-group"},Ut=e("li",{style:{"list-style-type":"none"}},[e("small",{class:"text-danger d-flex justify-content-end"},"最多小數點第二位")],-1),Vt={class:"row"},Lt={class:"col-1"},jt=["onUpdate:modelValue"],Rt={class:"col-7"},Dt={class:"text-wrap instrumentName"},Et={class:"col-4"},Ot={class:"input-group input-group-sm input-group-merge"},Pt=["onUpdate:modelValue"],$t=e("span",{class:"input-group-text"},"%",-1),qt=e("div",{class:"modal-body"},"確定刪除?",-1),Yt=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"關閉",-1),Kt=H({__name:"ServiceItemComponent",props:{initialServiceItem:{type:Object,required:!1,default:()=>{}},initialInstruments:{type:Array,required:!1,default:()=>[]}},setup(A){const p=ge(),i=Se.getInstance(),M=y.getInstance(),l=A;_e(async()=>{l.initialServiceItem?.labType&&(await i.fetchServiceCategoriesByLabType(l.initialServiceItem.labType).then(s=>{m.value=s.map(t=>({id:t.id,name:t.chineseName,value:t.id}))}),await i.fetchServiceSubCategoriesByServiceCategoryId(l.initialServiceItem.serviceCategory).then(s=>{f.value=s.map(t=>({id:t.id,name:t.chineseName,value:t.id}))}),await M.fetchUsersByLabType(l.initialServiceItem.labType).then(s=>{w.value=s.map(t=>({id:t.id,name:t.name,value:t.id}))}))});const{serviceItemCreationFormSchema:N}=Ce(),U=he().map(s=>({id:s.id,name:s.name,value:s.id})),n=u(""),c=u(!1),m=u([]),f=u([]),J=u(Ie()),S=u(l.initialInstruments),w=u([]),k=u(""),O=B(()=>S.value.filter(s=>s.checked).reduce((s,t)=>s+Number(t.percentage),0)),b=B(()=>S.value.filter(s=>s.checked)),K=B(()=>S.value.filter(s=>k.value?s.name.includes(k.value):!0)),V=B(()=>b.value.length===0?!0:b.value.length!==0&&ne()),{handleSubmit:Q,values:P,errors:zt,defineField:F,resetForm:W}=be({validationSchema:N,initialValues:l.initialServiceItem}),[G]=F("checkServiceSubCategory"),[ee]=F("serviceSubCategory"),[te]=F("labType"),[se]=F("serviceCategory");Y(te,(s,t)=>{s&&s!==t&&ae()}),Y(se,(s,t)=>{s&&s!==t&&(oe(),ee.value=void 0)});const ae=()=>{i.fetchServiceCategoriesAndInstrumentsByLabType(P.labType).then(s=>{m.value=s[0]?.map(t=>({id:t.id,name:t.chineseName,value:t.id})),S.value=s[1],w.value=s[2].map(t=>({id:t.id,name:t.name,value:t.id}))}).catch(s=>{m.value.length=0})},oe=()=>{i.fetchServiceSubCategoriesByServiceCategoryId(P.serviceCategory).then(s=>{f.value=s.map(t=>({id:t.id,name:t.chineseName,value:t.id})),G.value=s.length!==0}).catch(s=>{f.value.length=0})},le=()=>`比例總和為${O.value}%，少於或超過100%，請重新調整比例`,ne=()=>O.value==100,$=Q(async s=>{if(V.value)if(l.initialServiceItem)try{const t=await i.updateServiceItem(s,b.value);c.value=!0,n.value=t}catch(t){c.value=!1,n.value=t.message}else try{const t=await i.createServiceItem(s,b.value);c.value=!0,n.value=t,W(),w.value.length=0,S.value.length=0}catch(t){c.value=!1,n.value=t.response.data}}),ce=()=>{i.deleteServiceItemById(l.initialServiceItem.id).then(s=>{c.value=!0,p.push({name:"ServiceItemManagement",params:{message:s}})}).catch(s=>{c.value=!1,n.value="刪除失敗"})};return(s,t)=>{const ie=_("AppMessage"),L=_("AppSelect"),d=_("AppInput"),re=_("AppTextarea"),C=_("AppRadio"),q=_("AppCard"),de=_("router-link");return r(),v(T,null,[n.value?(r(),z(ie,{key:0,message:n.value,success:c.value},null,8,["message","success"])):X("",!0),e("form",{onSubmit:t[0]||(t[0]=(...o)=>h($)&&h($)(...o))},[a(q,null,{header:I(()=>[R(" 服務項目 ")]),body:I(()=>[e("div",we,[ke,e("div",Fe,[a(L,{id:"labType",name:"labType",options:h(U)},null,8,["options"])])]),e("div",Be,[Te,e("div",Ae,[a(d,{name:"code"})])]),e("div",Me,[Ne,e("div",Ue,[a(d,{name:"name"})])]),e("div",Ve,[Le,e("div",je,[a(re,{name:"note"})])]),e("div",Re,[De,e("div",Ee,[e("div",Oe,[Pe,a(L,{id:"serviceCategory",name:"serviceCategory",options:m.value},null,8,["options"])])]),g(e("div",$e,[e("div",qe,[Ye,a(d,{name:"checkServiceSubCategory",type:"hidden"}),a(L,{id:"serviceSubCategory",name:"serviceSubCategory",options:f.value},null,8,["options"])])],512),[[D,f.value.length]])]),e("div",ze,[Xe,e("div",Ze,[a(xe,{name:"owners",options:w.value},null,8,["options"])])]),e("div",He,[Je,e("div",Ke,[a(d,{name:"firstItemUnit"})]),R(" * "),e("div",Qe,[a(d,{name:"secondItemUnit"})])]),e("div",We,[Ge,e("div",et,[(r(!0),v(T,null,E(J.value,o=>(r(),z(C,{id:o.name,name:"sampleCategory",label:o.description,"checked-value":o.name,key:o},null,8,["id","label","checked-value"]))),128))])]),e("div",tt,[st,e("div",at,[a(d,{type:"number",min:"0",name:"externalCharge"})])]),e("div",ot,[lt,e("div",nt,[a(d,{type:"number",min:"0",name:"exchangeRate"})])]),e("div",ct,[it,e("div",rt,[a(d,{type:"number",min:"0",name:"academicServiceItemFee"})])]),e("div",dt,[mt,e("div",ut,[a(d,{type:"number",min:"0",name:"industryServiceItemFee"})])]),e("fieldset",vt,[pt,e("div",_t,[a(C,{id:"deductionFromBalanceY",name:"deductionFromBalance",label:"是","checked-value":!0}),a(C,{id:"deductionFromBalanceN",name:"deductionFromBalance",label:"否","checked-value":!1})])]),e("fieldset",ht,[bt,e("div",gt,[a(C,{id:"fillFeeManuallyY",name:"fillFeeManually",label:"是","checked-value":!0}),a(C,{id:"fillFeeManuallyN",name:"fillFeeManually",label:"否","checked-value":!1})])])]),_:1}),a(q,{class:"mt-3"},{header:I(()=>[e("div",yt,[ft,g(e("span",{class:"text-danger"},x(le()),513),[[D,!V.value]])])]),body:I(()=>[g(e("table",St,[e("tbody",null,[(r(!0),v(T,null,E(b.value,o=>(r(),v("tr",{key:o.id},[e("td",null,x(o.name),1),e("td",null,x(o.percentage)+"%",1)]))),128))])],512),[[D,b.value.length]])]),_:1}),e("div",Ct,[e("button",{type:"submit",class:"btn btn-primary",disabled:!V.value},x(l.initialServiceItem?"更新":"建立"),9,It),l.initialServiceItem?.deletable?(r(),v("button",xt," 刪除 ")):X("",!0),a(de,{to:{name:"ServiceItemManagement"},class:"btn btn-outline-secondary"},{default:I(()=>[R("回到服務項目管理")]),_:1})])],32),e("div",wt,[e("div",kt,[e("div",Ft,[Bt,e("div",Tt,[e("div",At,[Mt,g(e("input",{id:"filter",type:"text",class:"form-control","onUpdate:modelValue":t[1]||(t[1]=o=>k.value=o)},null,512),[[Z,k.value]])]),e("ul",Nt,[Ut,(r(!0),v(T,null,E(K.value,o=>(r(),v("li",{class:"list-group-item instrument",key:o.id},[e("div",Vt,[e("div",Lt,[g(e("input",{type:"checkbox","onUpdate:modelValue":j=>o.checked=j},null,8,jt),[[ye,o.checked]])]),e("div",Rt,[e("span",Dt,x(o.name),1)]),e("div",Et,[e("div",Ot,[g(e("input",{type:"number",min:"0",max:"100",step:"0.01",class:"form-control",onblur:"this.value=Number.parseFloat(this.value).toFixed(2);","onUpdate:modelValue":j=>o.percentage=j},null,8,Pt),[[Z,o.percentage]]),$t])])])]))),128))])])])])]),e("div",{class:"modal fade",id:"exampleModal",tabindex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true"},[e("div",{class:"modal-dialog"},[e("div",{class:"modal-content"},[qt,e("div",{class:"modal-footer"},[Yt,e("button",{type:"button",class:"btn btn-primary","data-bs-dismiss":"modal",onClick:ce}," 確定 ")])])])])],64)}}});export{Kt as _};
