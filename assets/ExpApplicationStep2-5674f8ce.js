import{d as U,c as P,e as w,o as h,f as S,g as e,F as O,A as z,t as y,B as x,h as t,w as f,C as T,j as l,Z as ce,$ as me,a0 as de,y as ee,z as pe,r as N,a as oe,m as H,N as ue,i as M,v as Z,D as Q,a1 as le,n as J,a2 as K,R as ve,Q as fe,a3 as a,a4 as he,a5 as W}from"./index-224d4b7d.js";import{S as B,g as X}from"./SampleCategory-297f54b4.js";import{a as R,_ as be,b as ge}from"./LivingForm.vue_vue_type_script_setup_true_lang-767236a3.js";import{g as _e}from"./SelectedIhcCommissionedItemPanel-07fdbe27.js";import{l as ye,s as Fe,n as we}from"./formSchema-a235e8ac.js";import"./LocationService-83028c48.js";const Se={class:"list-group"},Ce={class:"breadcrumb"},$e={class:"breadcrumb-item"},ke={class:"breadcrumb-item"},Le={key:0,class:"breadcrumb-item"},Te={key:1,class:"breadcrumb-item"},Ie={class:"breadcrumb-item"},Ae={class:"breadcrumb-item"},Ne=U({inheritAttrs:!1,__name:"CompletedLivingForm",props:{livingForm:{}},setup(g){const m=g,s=P(()=>de(m.livingForm.iacucProtocol));return(r,v)=>{const F=w("AppDownloadLink");return h(),S("div",ce(me(r.$attrs)),[e("ul",Se,[(h(!0),S(O,null,z(r.livingForm.deliveries,(p,L)=>(h(),S("li",{class:"list-group-item bg-info mb-1",key:L},[e("ol",Ce,[e("li",$e," 品系: "+y(p.strain==="ratOther"?p.ratOtherStrain:p.strain==="miceOther"?p.miceOtherStrain:p.strain),1),e("li",ke,"週齡: "+y(p.age),1),p.maleQty?(h(),S("li",Le,"公: "+y(p.maleQty||0),1)):x("",!0),p.femaleQty?(h(),S("li",Te,"母: "+y(p.femaleQty||0),1)):x("",!0),e("li",Ie,"送來的籠數: "+y(p.sendingCagesQty),1),e("li",Ae,"實驗籠數: "+y(p.expCage),1)])]))),128))]),t(R,{label:"物種"},{content:f(()=>[T(y(l(_e)(r.livingForm.animalType)),1)]),_:1}),t(R,{label:"預計運送動物日期"},{content:f(()=>[T(y(r.livingForm.animalArrivalDate),1)]),_:1}),t(R,{label:"預計運送動物時間"},{content:f(()=>[T(y(r.livingForm.animalArrivalTime==="morning"?"上午9:00~12:00":"下午13:30~16:30"),1)]),_:1}),t(R,{label:"IACUC Number"},{content:f(()=>[T(y(r.livingForm.iacucNo),1)]),_:1}),t(R,{label:"IACUC Protocol"},{content:f(()=>[t(F,{name:s.value.name,value:s.value.value},null,8,["name","value"])]),_:1}),t(R,{label:"Note"},{content:f(()=>[T(y(r.livingForm.note),1)]),_:1})],16)}}}),j=g=>{for(let m in g)if(g.hasOwnProperty(m)){let s=g[m];typeof s=="object"&&s!==null&&!Array.isArray(s)?(j(s),Object.keys(s).length===0&&delete g[m]):Array.isArray(s)?s.length===0&&delete g[m]:(s===""||s===null||s===void 0)&&delete g[m]}return g},xe={class:"mt-4"},Ee=e("h5",{class:"mb-0"},"填寫動物入室資料",-1),De={class:"row mb-3"},Oe=e("label",{for:"iacucfile",class:"col-sm-2 col-form-label"},"選擇表單來源",-1),Ve={class:"col-8 mb-3"},Be={class:"input-group"},Re={class:"row mb-3"},Me={class:"d-flex flex-row-reverse mt-2"},Pe={class:"nav nav-tabs",id:"myTab",role:"tablist"},Qe=["id","data-bs-target","aria-controls"],Ue={class:"tab-content"},Ge=["id","aria-labelledby","tabindex"],Ze={class:"mt-2 d-flex flex-row-reverse"},je=["onClick"],ze=["onClick"],Ye={class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},qe=U({__name:"LivingFormEditingZone",props:{livingForms:{},bindingCageNumber:{type:Boolean},showCellLineInfoFrom:{type:Boolean},showMedicationInfoFrom:{type:Boolean},formSourceVisibility:{type:Boolean,default:!0}},emits:["saveLivingForm","addLivingForm","updateLivingForm","deleteForm"],async setup(g,{emit:m}){let s,r;const v=g,F=m,p=ee(),L=([s,r]=pe(()=>p.fetchFormSourceOptions()),s=await s,r(),s),o=N(!1),c=N(-1),u={deliveries:[{}],showMedicationInfoFrom:v.showMedicationInfoFrom,showCellLineInfoFrom:v.showCellLineInfoFrom},{handleSubmit:b,values:_,resetForm:C,errors:n}=oe({initialValues:u,validationSchema:ye});le("errors",n);function $(d={deliveries:[{strain:"",ratOtherStrain:"",miceStrainOther:"",special:"",specialExplain:"",age:"",maleQty:0,femaleQty:0,sendingCagesQty:0,expCage:0}]}){C({values:d},{force:!0})}const G=b(d=>{var E,D,A;const i=H.cloneDeep(d);i.pathologicalExp!=="Y"?(delete i.blood,delete i.tissueSection,delete i.ihc,delete i.slideScanning,delete i.histopathology):((E=i.pathologicalExpType)!=null&&E.includes("TissueSection")||delete i.tissueSection,(D=i.pathologicalExpType)!=null&&D.includes("ihc")||delete i.ihc,(A=i.pathologicalExpType)!=null&&A.includes("Blood")||delete i.blood),i.id=ue(),F("addLivingForm",j(i)),$(u)}),V=b(d=>{var E,D,A;const i=H.cloneDeep(d);i.pathologicalExp!=="Y"?(delete i.blood,delete i.tissueSection,delete i.ihc,delete i.slideScanning,delete i.histopathology):((E=i.pathologicalExpType)!=null&&E.includes("TissueSection")||delete i.tissueSection,(D=i.pathologicalExpType)!=null&&D.includes("ihc")||delete i.ihc,(A=i.pathologicalExpType)!=null&&A.includes("Blood")||delete i.blood),F("updateLivingForm",{form:j(i),index:c.value}),$(),c.value=-1,o.value=!1}),ae=d=>{o.value=!0,c.value=d;const i=v.livingForms[d];$(i),window.scrollTo({top:100,behavior:"smooth"})},ne=d=>{F("deleteForm",d),o.value=!1,c.value=d},ie=()=>{F("saveLivingForm")};function te(){c.value=-1,o.value=!1;const d=p.fetchLivingForm(_.formSource);$(d)}const se=P(()=>{const d=Object.keys(n.value).length;return d!==0?`尚有${d}個項目未填寫`:""});return(d,i)=>{var Y,q;const E=w("AppFloatingMessage"),D=w("AppSelect"),A=w("AppCard");return h(),S(O,null,[t(E,{message:se.value},null,8,["message"]),e("form",xe,[t(A,{class:"mt-4"},{header:f(()=>[Ee]),body:f(()=>[M(e("div",De,[Oe,e("div",Ve,[e("div",Be,[t(D,{name:"formSource",options:l(L),onChange:i[0]||(i[0]=I=>te()),"default-option":!1,value:"new"},null,8,["options"])])])],512),[[Z,d.formSourceVisibility]]),e("div",Re,[t(be,{"binding-cage-number":d.bindingCageNumber,"show-cell-line-info-from":d.showCellLineInfoFrom,"show-medication-info-from":d.showMedicationInfoFrom,"necropsy-application-visibility":l(_).formSource!=="new",values:l(_)},null,8,["binding-cage-number","show-cell-line-info-from","show-medication-info-from","necropsy-application-visibility","values"]),e("div",Me,[M(e("button",{class:"btn btn-primary",type:"button",onClick:i[1]||(i[1]=(...I)=>l(V)&&l(V)(...I))}," 修改 ",512),[[Z,o.value]]),M(e("button",{class:"btn btn-info text-white",type:"button",onClick:i[2]||(i[2]=(...I)=>l(G)&&l(G)(...I))}," 填寫完畢 ",512),[[Z,!o.value]])])])]),_:1}),(Y=d.livingForms)!=null&&Y.length?(h(),Q(A,{key:0,class:"mt-2"},{title:f(()=>[T(" 已填寫入室申請表 ")]),body:f(()=>[e("ul",Pe,[(h(!0),S(O,null,z(d.livingForms,(I,k)=>(h(),S("li",{class:"nav-item",role:"presentation",key:I.id},[e("button",{class:J(["nav-link",{active:k===0}]),id:`homeTab${k}`,"data-bs-toggle":"tab","data-bs-target":`#tabPanel${k}`,type:"button",role:"tab","aria-controls":`tabPanel${k}`,"aria-selected":"true"}," #"+y(k+1),11,Qe)]))),128))]),e("div",Ue,[(h(!0),S(O,null,z(d.livingForms,(I,k)=>(h(),S("div",{class:J(["tab-pane p-2",{active:k===0}]),id:`tabPanel${k}`,role:"tabpanel","aria-labelledby":`homeTab${k}`,tabindex:k,key:I.id},[t(Ne,{livingForm:I},null,8,["livingForm"]),e("div",Ze,[e("button",{type:"button",class:"btn btn-secondary",onClick:K(re=>ae(k),["prevent"])}," 編輯 ",8,je),e("button",{type:"button",class:"btn btn-danger mx-1",onClick:K(re=>ne(k),["prevent"])}," 刪除 ",8,ze)])],10,Ge))),128))])]),_:1})):x("",!0),e("div",Ye,[M(e("button",{type:"button",class:"btn btn-primary",onClick:ie}," 下一步 ",512),[[Z,(q=d.livingForms)==null?void 0:q.length]])])])],64)}}}),He={class:"row mb-3"},Je=["for"],Ke={class:"col-8"},We={class:"row mb-3"},Xe=["for"],eo={class:"col-8"},oo={class:"row mb-3"},lo=["for"],ao={class:"col-8"},no={class:"row mb-3"},io=["for"],to={class:"col-8"},so={class:"row mb-3"},ro=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star"},"實驗類型",-1),co={class:"col-sm-10"},mo={class:"row mb-3"},po=["for"],uo={class:"col-8"},vo=e("i",{class:"bi bi-cloud-download"},null,-1),fo=[vo],ho={id:"radiologyRelated"},bo={class:"row mb-3"},go=["for"],_o={class:"col-8"},yo={class:"row mb-3"},Fo=["for"],wo={class:"col-8"},So={class:"row mb-3"},Co=["for"],$o={class:"col-8"},ko={class:"row mb-3"},Lo=["for"],To={class:"col-8"},Io={class:"row mb-3"},Ao=["for"],No={class:"col-8"},xo={id:"otherRelated"},Eo={class:"row mb-3"},Do=["for"],Oo={class:"col-8"},Vo={class:"row mb-3"},Bo=["for"],Ro={class:"col-8"},Mo={class:"row mb-3"},Po=["for"],Qo={class:"col-8"},Uo={class:"row mb-3"},Go=["for"],Zo={class:"col-8"},jo={class:"row mb-3"},zo=["for"],Yo={class:"col-8"},qo=U({__name:"NonLivingForm",props:{values:{},prefix:{default:()=>""}},setup(g){const m=g,{loggedInUser:s}=ve(fe()),r=o=>m.values.experimentType!==void 0&&m.values.experimentType.includes(o),v=P(()=>{var o;return m.values.contact?m.values.contact:(o=s.value)==null?void 0:o.title}),F=P(()=>{var o;return m.values.contactTel?m.values.contactTel:(o=s.value)==null?void 0:o.phone}),p=P(()=>{var o;return m.values.contactEmail?m.values.contactEmail:(o=s.value)==null?void 0:o.username}),L=()=>{let c="data:text/csv;charset=utf-8,"+[["No.","Sample ID (只可填入14字元，包括空格及標點符號)"],["",""]].map(_=>_.join(",")).join(`
`);var u=encodeURI(c),b=document.createElement("a");b.setAttribute("href",u),b.setAttribute("download","sample.csv"),document.body.appendChild(b),b.click()};return(o,c)=>{const u=w("AppInput"),b=w("AppCheckbox"),_=w("AppDownloadFileInput"),C=w("AppBlock"),n=w("AppRadio"),$=w("AppRadioInput");return h(),S(O,null,[e("div",He,[e("label",{for:l(a)(o.prefix,"contact"),class:"col-sm-2 col-form-label red-star"},"申請者姓名",8,Je),e("div",Ke,[t(u,{name:l(a)(o.prefix,"contact"),value:v.value},null,8,["name","value"])])]),e("div",We,[e("label",{for:l(a)(o.prefix,"contactTel"),class:"col-sm-2 col-form-label red-star"},"申請者電話",8,Xe),e("div",eo,[t(u,{name:l(a)(o.prefix,"contactTel"),value:F.value},null,8,["name","value"])])]),e("div",oo,[e("label",{for:l(a)(o.prefix,"contactEmail"),class:"col-sm-2 col-form-label red-star"},"申請者信箱",8,lo),e("div",ao,[t(u,{type:"email",name:l(a)(o.prefix,"contactEmail"),value:p.value},null,8,["name","value"])])]),e("div",no,[e("label",{for:l(a)(o.prefix,"scheduledDeliveryDate"),class:"col-sm-2 col-form-label red-star"},"約定的送件日期",8,io),e("div",to,[t(u,{type:"date",name:l(a)(o.prefix,"scheduledDeliveryDate")},null,8,["name"])])]),e("fieldset",so,[ro,e("div",co,[t(b,{label:"病理學",name:l(a)(o.prefix,"experimentType"),id:l(a)(o.prefix,"experimentTypePathology"),"checked-value":"pathology"},null,8,["name","id"]),t(b,{label:"斷層掃描",name:l(a)(o.prefix,"experimentType"),id:l(a)(o.prefix,"experimentTypeRadiology"),"checked-value":"radiology"},null,8,["name","id"]),t(b,{label:"其它",name:l(a)(o.prefix,"experimentType"),id:l(a)(o.prefix,"experimentTypeOther"),"checked-value":"other"},null,8,["name","id"])])]),r("pathology")?(h(),Q(C,{key:0,class:"my-2"},{title:f(()=>[T(" 病理學 ")]),content:f(()=>[e("div",mo,[e("label",{for:l(a)(o.prefix,"uploadedSampleSheetFile"),class:"col-sm-2 col-form-label red-star"},"上傳檢體編號表",8,po),e("div",uo,[t(_,{name:l(a)(o.prefix,"uploadedSampleSheetFile"),schema:l(Fe)},null,8,["name","schema"]),e("div",null,[T(" 檢體編號表範本"),e("a",{href:"#",onClick:L},fo)])])]),t(ge,{prefix:o.prefix,values:o.values,visible:r("pathology")},null,8,["prefix","values","visible"])]),_:1})):x("",!0),r("radiology")?(h(),Q(C,{key:1,class:"my-2"},{title:f(()=>[T(" 影像學 ")]),content:f(()=>[e("div",ho,[e("div",bo,[e("label",{for:l(a)(o.prefix,"radiology.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,go),e("div",_o,[t(u,{id:l(a)(o.prefix,"radiology.sampleNumber"),type:"number",name:l(a)(o.prefix,"radiology.sampleNumber")},null,8,["id","name"])])]),e("div",yo,[e("label",{for:l(a)(o.prefix,"radiology.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,Fo),e("div",wo,[t(u,{type:"text",id:l(a)(o.prefix,"radiology.sampleId"),name:l(a)(o.prefix,"radiology.sampleId")},null,8,["id","name"])])]),e("div",So,[e("label",{for:l(a)(o.prefix,"radiology.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,Co),e("div",$o,[t(n,{name:l(a)(o.prefix,"radiology.sampleType"),id:l(a)(o.prefix,"radiology.sampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),t($,{label:"其他",id:l(a)(o.prefix,"radiologyOtherSampleType"),"radio-name":l(a)(o.prefix,"radiology.sampleType"),"checked-value":"other","input-name":l(a)(o.prefix,"radiology.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",ko,[e("label",{for:l(a)(o.prefix,"radiology.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,Lo),e("div",To,[t(_,{name:l(a)(o.prefix,"radiology.attachment")},null,8,["name"])])]),e("div",Io,[e("label",{for:l(a)(o.prefix,"radiology.note"),class:"col-sm-2 col-form-label"},"備註",8,Ao),e("div",No,[t(u,{type:"text",id:l(a)(o.prefix,"radiology.note"),name:l(a)(o.prefix,"radiology.note")},null,8,["id","name"])])])])]),_:1})):x("",!0),r("other")?(h(),Q(C,{key:2,class:"my-2"},{title:f(()=>[T(" 其他 ")]),content:f(()=>[e("div",xo,[e("div",Eo,[e("label",{for:l(a)(o.prefix,"other.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,Do),e("div",Oo,[t(u,{id:l(a)(o.prefix,"other.sampleNumber"),type:"number",name:l(a)(o.prefix,"other.sampleNumber")},null,8,["id","name"])])]),e("div",Vo,[e("label",{for:l(a)(o.prefix,"other.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,Bo),e("div",Ro,[t(u,{type:"text",id:l(a)(o.prefix,"other.sampleId"),name:l(a)(o.prefix,"other.sampleId")},null,8,["id","name"])])]),e("div",Mo,[e("label",{for:l(a)(o.prefix,"other.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,Po),e("div",Qo,[t(n,{name:l(a)(o.prefix,"other.sampleType"),id:l(a)(o.prefix,"otherSampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),t($,{label:"其他",id:l(a)(o.prefix,"otherOtherSampleType"),"radio-name":l(a)(o.prefix,"other.sampleType"),"checked-value":"other","input-name":l(a)(o.prefix,"other.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",Uo,[e("label",{for:l(a)(o.prefix,"other.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,Go),e("div",Zo,[t(_,{name:l(a)(o.prefix,"other.attachment")},null,8,["name"])])]),e("div",jo,[e("label",{for:l(a)(o.prefix,"other.note"),class:"col-sm-2 col-form-label"},"備註",8,zo),e("div",Yo,[t(u,{type:"text",id:l(a)(o.prefix,"other.note"),name:l(a)(o.prefix,"other.note")},null,8,["id","name"])])])])]),_:1})):x("",!0)],64)}}}),Ho=e("h5",{class:"mb-0"},"填寫非活體資料",-1),Jo=e("div",{class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},[e("button",{type:"submit",class:"btn btn-primary"},"下一步")],-1),Ko=U({__name:"NonLivingFormEditingZone",props:{nonLivingForm:{}},emits:["saveNonLivingForm"],setup(g,{emit:m}){const s=g,r=m,{handleSubmit:v,values:F,errors:p}=oe({initialValues:s.nonLivingForm,validationSchema:we});le("errors",p);const L=v(c=>{var u,b,_,C;(u=c.experimentType)!=null&&u.includes("pathology")?((b=c.pathologicalExpType)!=null&&b.includes("TissueSection")||delete c.tissueSection,(_=c.pathologicalExpType)!=null&&_.includes("ihc")||delete c.ihc,(C=c.pathologicalExpType)!=null&&C.includes("Blood")||delete c.blood):(delete c.blood,delete c.tissueSection,delete c.ihc,delete c.slideScanning,delete c.histopathology),r("saveNonLivingForm",j(c))}),o=P(()=>{const c=Object.keys(p.value).length;return c!==0?`尚有${c}個項目未填寫`:""});return(c,u)=>{const b=w("AppFloatingMessage"),_=w("AppCard");return h(),S(O,null,[t(b,{message:o.value},null,8,["message"]),e("form",{id:"nonLivingFormEditingZone",onSubmit:u[0]||(u[0]=(...C)=>l(L)&&l(L)(...C)),class:"mt-4"},[t(_,{class:"mt-4"},{header:f(()=>[Ho]),body:f(()=>[t(qo,{values:l(F)},null,8,["values"])]),_:1}),Jo],32)],64)}}}),Wo=e("h4",{class:"fw-bold py-3 mb-4"},"實驗類型",-1),Xo=e("h5",{class:"mb-0"},"活體/非活體",-1),el={class:"form-check form-check-inline"},ol=["value"],ll={class:"form-check-label",for:"living"},al={class:"form-check form-check-inline"},nl=["value"],il={class:"form-check-label",for:"nonLiving"},pl=U({__name:"ExpApplicationStep2",props:{id:{}},setup(g){console.log("step2");const m=g,s=ee(),r=N(),v=N(),F=N(),p=N(!1),L=N(!1),o=N(!1);he(async()=>{await s.loadDataForStep2(m.id).then(n=>{r.value=n==null?void 0:n.sampleCategory,v.value=(n==null?void 0:n.livingForms)===void 0?[]:n.livingForms,F.value=n==null?void 0:n.nonLivingForm,p.value=n==null?void 0:n.bindingCageNumber,L.value=(n==null?void 0:n.showCellLineInfoFrom)||!1,o.value=(n==null?void 0:n.showMedicationInfoFrom)||!1}).catch(n=>{console.log(n)})});const c=async()=>{r.value&&v.value&&await s.saveLivingForms(m.id,r.value,v.value).then(()=>{s.proceedToStep3(m.id)})},u=n=>{v.value===void 0&&(v.value=[]),v.value.push(n)},b=n=>{v.value===void 0&&(v.value=[]),v.value[n.index]=n.form},_=n=>{v.value&&v.value.splice(n,1)},C=async n=>{r.value&&await s.saveNonLivingForm(m.id,r.value,n).then(()=>{s.proceedToStep3(m.id)})};return(n,$)=>{const G=w("AppCard");return h(),S(O,null,[Wo,t(G,null,{header:f(()=>[Xo]),body:f(()=>[e("div",el,[M(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:l(B).LIVING,id:"living","onUpdate:modelValue":$[0]||($[0]=V=>r.value=V)},null,8,ol),[[W,r.value]]),e("label",ll,y(l(X)(l(B).LIVING)),1)]),e("div",al,[M(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:l(B).NON_LIVING,id:"nonLiving","onUpdate:modelValue":$[1]||($[1]=V=>r.value=V)},null,8,nl),[[W,r.value]]),e("label",il,y(l(X)(l(B).NON_LIVING)),1)])]),_:1}),r.value===l(B).LIVING?(h(),Q(qe,{key:0,"binding-cage-number":p.value,"living-forms":v.value?v.value:[],"show-medication-info-from":o.value,"show-cell-line-info-from":L.value,onSaveLivingForm:c,onAddLivingForm:u,onUpdateLivingForm:b,onDeleteForm:_},null,8,["binding-cage-number","living-forms","show-medication-info-from","show-cell-line-info-from"])):x("",!0),r.value===l(B).NON_LIVING?(h(),Q(Ko,{key:1,"non-living-form":F.value,onSaveNonLivingForm:C},null,8,["non-living-form"])):x("",!0)],64)}}});export{pl as default};
