var pe=Object.defineProperty;var _e=(u,c,n)=>c in u?pe(u,c,{enumerable:!0,configurable:!0,writable:!0,value:n}):u[c]=n;var D=(u,c,n)=>(_e(u,typeof c!="symbol"?c+"":c,n),n);import{d as Q,a6 as he,o as m,f as h,h as a,a1 as be,j as y,k as ge,a_ as ye,D as fe,aZ as Se,r as _,c as A,a as Ce,a4 as G,e as b,B as H,y as J,g as e,w,z as E,i as S,v as O,F as M,x as P,t as k,E as K,l as Ie,ad as xe}from"./index-72e9df21.js";import{G as we,S as ke}from"./ServiceItemService-b6f61e1f.js";import{u as Fe}from"./FormSchemaStore-57a1ad6d.js";import{a as Be}from"./SampleCategory-297f54b4.js";const Te=Q({__name:"AppSelectUser",props:{name:{},options:{default:()=>[]}},setup(u){const c=u,{value:n,errorMessage:N,handleBlur:i,handleChange:U}=he(()=>c.name,void 0),V=r=>{U(r.map(d=>d.value))};return(r,d)=>(m(),h("div",null,[a(y(ye),be({class:["form-control",{"is-invalid":y(N)?"is-invalid":""}],options:r.options,placeholder:"請選擇",label:"name",reduce:p=>p.id,onBlur:y(i),"onOption:selected":V},r.$attrs,{modelValue:y(n),"onUpdate:modelValue":d[0]||(d[0]=p=>ge(n)?n.value=p:null),multiple:""}),null,16,["class","options","reduce","onBlur","modelValue"])]))}}),g=class g{constructor(c){D(this,"api");this.api=c}static getInstance(){return g.instance||(g.instance=new g(we)),g.instance}async fetchUsersByLabType(c){return await this.api.apiFetchUsersByLabType(c)}};D(g,"instance");let $=g;const Ae={class:"row mb-2"},Me=e("label",{for:"labType",class:"col-sm-2 col-form-label red-star"},"單位 ",-1),Ne={class:"col-sm-4"},Ue={class:"row mb-2"},Ve=e("label",{for:"code",class:"col-sm-2 col-form-label red-star"},"Service Item Code ",-1),Le={class:"col-sm-4"},je={class:"row mb-2"},Re=e("label",{for:"name",class:"col-sm-2 col-form-label red-star"},"Service Item Name ",-1),De={class:"col-sm-9"},Ee={class:"row mb-2"},Oe=e("label",{for:"note",class:"col-sm-2 col-form-label"},"Note",-1),Pe={class:"col-sm-9"},$e={class:"row mb-2"},qe=e("label",{for:"type",class:"col-sm-2 col-form-label red-star"},"服務項目類別",-1),Ye={class:"col-sm-4",id:"type"},ze={class:"input-group"},Xe=e("label",{class:"input-group-text",for:"serviceCategory"},"大類",-1),Ze={class:"col-sm-4"},Ge={class:"input-group"},He=e("label",{class:"input-group-text",for:"serviceSubCategory"},"小類",-1),Je={class:"row mb-2"},Ke=e("label",{for:"owner",class:"col-sm-2 col-form-label red-star"},"負責人",-1),Qe={class:"col-sm-9"},We={class:"row mb-2"},et=e("label",{for:"firstItemUnit",class:"col-sm-2 col-form-label red-star"},"Sample amount 之單位 ",-1),tt={class:"col-3"},st={class:"col-3"},at={class:"row mb-2"},ot=e("label",{for:"sampleCategory",class:"col-sm-2 col-form-label red-star"},"樣本種類",-1),lt={class:"col-sm-8"},nt={class:"row mb-2"},ct=e("label",{for:"externalCharge",class:"col-sm-2 col-form-label"},"外界單位收費(產)",-1),it={class:"col-sm-9"},rt={class:"row mb-2"},dt=e("label",{for:"exchangeRate",class:"col-sm-2 col-form-label"},"匯率",-1),mt={class:"col-sm-9"},ut={class:"row mb-2"},vt=e("label",{for:"academicServiceItemFee",class:"col-sm-2 col-form-label red-star"},"學術費用",-1),pt={class:"col-sm-4"},_t={class:"row mb-2"},ht=e("label",{for:"industryServiceItemFee",class:"col-sm-2 col-form-label red-star"},"產業界費用",-1),bt={class:"col-sm-4"},gt={class:"row mb-2"},yt=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star"},"是否允許扣除餘額",-1),ft={class:"col-sm-9"},St={class:"row mb-2"},Ct=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star","red-star":""},"是否可自行填寫金額",-1),It={class:"col-sm-9"},xt={class:"d-flex justify-content-between"},wt=e("button",{type:"button",class:"btn btn-primary","data-bs-toggle":"modal","data-bs-target":"#modalCenter"}," 設定儀器 ",-1),kt={class:"table table-borderless"},Ft={class:"mt-2 d-flex justify-content-between flex-row-reverse"},Bt=["disabled"],Tt={key:0,type:"button",class:"btn btn-danger mx-1","data-bs-toggle":"modal","data-bs-target":"#exampleModal"},At={class:"modal fade",id:"modalCenter",tabindex:"-1","aria-hidden":"true"},Mt={class:"modal-dialog modal-dialog-centered",role:"document"},Nt={class:"modal-content"},Ut=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"modalCenterTitle"},"選擇儀器"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1),Vt={class:"modal-body"},Lt={class:"input-group my-2"},jt=e("span",{class:"input-group-text",id:"basic-addon1"},"Search",-1),Rt={class:"list-group"},Dt=e("li",{style:{"list-style-type":"none"}},[e("small",{class:"text-danger d-flex justify-content-end"},"最多小數點第二位")],-1),Et={class:"row"},Ot={class:"col-1"},Pt=["onUpdate:modelValue"],$t={class:"col-7"},qt={class:"text-wrap instrumentName"},Yt={class:"col-4"},zt={class:"input-group input-group-sm input-group-merge"},Xt=["onUpdate:modelValue"],Zt=e("span",{class:"input-group-text"},"%",-1),Gt=e("div",{class:"modal-body"},"確定刪除?",-1),Ht=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"關閉",-1),ss=Q({__name:"ServiceItemComponent",props:{initialServiceItem:{type:Object,required:!1,default:()=>{}},initialInstruments:{type:Array,required:!1,default:()=>[]}},setup(u){const c=Ie(),n=ke.getInstance(),N=$.getInstance(),i=u;fe(async()=>{var t;(t=i.initialServiceItem)!=null&&t.labType&&(await n.fetchServiceCategoriesByLabType(i.initialServiceItem.labType).then(s=>{p.value=s.map(o=>({id:o.id,name:o.chineseName,value:o.id}))}),await n.fetchServiceSubCategoriesByServiceCategoryId(i.initialServiceItem.serviceCategory).then(s=>{C.value=s.map(o=>({id:o.id,name:o.chineseName,value:o.id}))}),await N.fetchUsersByLabType(i.initialServiceItem.labType).then(s=>{F.value=s.map(o=>({id:o.id,name:o.name,value:o.id}))}))});const{serviceItemCreationFormSchema:U}=Fe(),V=Se().map(t=>({id:t.id,name:t.name,value:t.id})),r=_(""),d=_(!1),p=_([]),C=_([]),W=_(Be()),I=_(i.initialInstruments),F=_([]),B=_(""),q=A(()=>I.value.filter(t=>t.checked).reduce((t,s)=>t+Number(s.percentage),0)),f=A(()=>I.value.filter(t=>t.checked)),ee=A(()=>I.value.filter(t=>B.value?t.name.includes(B.value):!0)),L=A(()=>f.value.length===0?!0:f.value.length!==0&&de()),{handleSubmit:te,values:Y,errors:Jt,defineField:T,resetForm:se}=Ce({validationSchema:U,initialValues:i.initialServiceItem}),[ae]=T("checkServiceSubCategory"),[oe]=T("serviceSubCategory"),[le]=T("labType"),[ne]=T("serviceCategory");G(le,(t,s)=>{t&&t!==s&&ce()}),G(ne,(t,s)=>{t&&t!==s&&(ie(),oe.value=void 0)});const ce=()=>{n.fetchServiceCategoriesAndInstrumentsByLabType(Y.labType).then(t=>{var s;p.value=(s=t[0])==null?void 0:s.map(o=>({id:o.id,name:o.chineseName,value:o.id})),I.value=t[1],F.value=t[2].map(o=>({id:o.id,name:o.name,value:o.id}))}).catch(t=>{p.value.length=0})},ie=()=>{n.fetchServiceSubCategoriesByServiceCategoryId(Y.serviceCategory).then(t=>{C.value=t.map(s=>({id:s.id,name:s.chineseName,value:s.id})),ae.value=t.length!==0}).catch(t=>{C.value.length=0})},re=()=>`比例總和為${q.value}%，少於或超過100%，請重新調整比例`,de=()=>q.value==100,z=te(async t=>{if(L.value)if(i.initialServiceItem)try{const s=await n.updateServiceItem(t,f.value);d.value=!0,r.value=s}catch(s){d.value=!1,r.value=s.message}else try{const s=await n.createServiceItem(t,f.value);d.value=!0,r.value=s,se(),F.value.length=0,I.value.length=0}catch(s){d.value=!1,r.value=s.response.data}}),me=()=>{n.deleteServiceItemById(i.initialServiceItem.id).then(t=>{d.value=!0,c.push({name:"ServiceItemManagement",params:{message:t}})}).catch(t=>{d.value=!1,r.value="刪除失敗"})};return(t,s)=>{var Z;const o=b("AppMessage"),j=b("AppSelect"),v=b("AppInput"),ue=b("AppTextarea"),x=b("AppRadio"),X=b("AppCard"),ve=b("router-link");return m(),h(M,null,[r.value?(m(),H(o,{key:0,message:r.value,success:d.value},null,8,["message","success"])):J("",!0),e("form",{onSubmit:s[0]||(s[0]=(...l)=>y(z)&&y(z)(...l))},[a(X,null,{header:w(()=>[E(" 服務項目 ")]),body:w(()=>[e("div",Ae,[Me,e("div",Ne,[a(j,{id:"labType",name:"labType",options:y(V)},null,8,["options"])])]),e("div",Ue,[Ve,e("div",Le,[a(v,{name:"code"})])]),e("div",je,[Re,e("div",De,[a(v,{name:"name"})])]),e("div",Ee,[Oe,e("div",Pe,[a(ue,{name:"note"})])]),e("div",$e,[qe,e("div",Ye,[e("div",ze,[Xe,a(j,{id:"serviceCategory",name:"serviceCategory",options:p.value},null,8,["options"])])]),S(e("div",Ze,[e("div",Ge,[He,a(v,{name:"checkServiceSubCategory",type:"hidden"}),a(j,{id:"serviceSubCategory",name:"serviceSubCategory",options:C.value},null,8,["options"])])],512),[[O,C.value.length]])]),e("div",Je,[Ke,e("div",Qe,[a(Te,{name:"owners",options:F.value},null,8,["options"])])]),e("div",We,[et,e("div",tt,[a(v,{name:"firstItemUnit"})]),E(" * "),e("div",st,[a(v,{name:"secondItemUnit"})])]),e("div",at,[ot,e("div",lt,[(m(!0),h(M,null,P(W.value,l=>(m(),H(x,{id:l.name,name:"sampleCategory",label:l.description,"checked-value":l.name,key:l},null,8,["id","label","checked-value"]))),128))])]),e("div",nt,[ct,e("div",it,[a(v,{type:"number",min:"0",name:"externalCharge"})])]),e("div",rt,[dt,e("div",mt,[a(v,{type:"number",min:"0",name:"exchangeRate"})])]),e("div",ut,[vt,e("div",pt,[a(v,{type:"number",min:"0",name:"academicServiceItemFee"})])]),e("div",_t,[ht,e("div",bt,[a(v,{type:"number",min:"0",name:"industryServiceItemFee"})])]),e("fieldset",gt,[yt,e("div",ft,[a(x,{id:"deductionFromBalanceY",name:"deductionFromBalance",label:"是","checked-value":!0}),a(x,{id:"deductionFromBalanceN",name:"deductionFromBalance",label:"否","checked-value":!1})])]),e("fieldset",St,[Ct,e("div",It,[a(x,{id:"fillFeeManuallyY",name:"fillFeeManually",label:"是","checked-value":!0}),a(x,{id:"fillFeeManuallyN",name:"fillFeeManually",label:"否","checked-value":!1})])])]),_:1}),a(X,{class:"mt-3"},{header:w(()=>[e("div",xt,[wt,S(e("span",{class:"text-danger"},k(re()),513),[[O,!L.value]])])]),body:w(()=>[S(e("table",kt,[e("tbody",null,[(m(!0),h(M,null,P(f.value,l=>(m(),h("tr",{key:l.id},[e("td",null,k(l.name),1),e("td",null,k(l.percentage)+"%",1)]))),128))])],512),[[O,f.value.length]])]),_:1}),e("div",Ft,[e("button",{type:"submit",class:"btn btn-primary",disabled:!L.value},k(i.initialServiceItem?"更新":"建立"),9,Bt),(Z=i.initialServiceItem)!=null&&Z.deletable?(m(),h("button",Tt," 刪除 ")):J("",!0),a(ve,{to:{name:"ServiceItemManagement"},class:"btn btn-outline-secondary"},{default:w(()=>[E("回到服務項目管理")]),_:1})])],32),e("div",At,[e("div",Mt,[e("div",Nt,[Ut,e("div",Vt,[e("div",Lt,[jt,S(e("input",{id:"filter",type:"text",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=l=>B.value=l)},null,512),[[K,B.value]])]),e("ul",Rt,[Dt,(m(!0),h(M,null,P(ee.value,l=>(m(),h("li",{class:"list-group-item instrument",key:l.id},[e("div",Et,[e("div",Ot,[S(e("input",{type:"checkbox","onUpdate:modelValue":R=>l.checked=R},null,8,Pt),[[xe,l.checked]])]),e("div",$t,[e("span",qt,k(l.name),1)]),e("div",Yt,[e("div",zt,[S(e("input",{type:"number",min:"0",max:"100",step:"0.01",class:"form-control",onblur:"this.value=Number.parseFloat(this.value).toFixed(2);","onUpdate:modelValue":R=>l.percentage=R},null,8,Xt),[[K,l.percentage]]),Zt])])])]))),128))])])])])]),e("div",{class:"modal fade",id:"exampleModal",tabindex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true"},[e("div",{class:"modal-dialog"},[e("div",{class:"modal-content"},[Gt,e("div",{class:"modal-footer"},[Ht,e("button",{type:"button",class:"btn btn-primary","data-bs-dismiss":"modal",onClick:me}," 確定 ")])])])])],64)}}});export{ss as _};
