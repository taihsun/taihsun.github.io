import{d as G,g as P,h as w,o as b,c as S,a as e,F as V,y as Y,t as F,z as N,j as a,w as h,A as L,l,S as ce,U as me,V as de,s as pe,r as A,e as oe,q as K,I as ue,k as R,v as j,B as U,K as le,W as ne,n as W,X as H,Y as ve,Z as fe,$ as n,D as he,x as be,a0 as J,a1 as B,a2 as ee}from"./index-8fed8339.js";import{N as ge,_ as _e}from"./SystemNotificationMessage.vue_vue_type_script_setup_true_lang-7b96dc71.js";import{a as M,_ as ye,b as Fe}from"./LivingForm.vue_vue_type_script_setup_true_lang-8e2b8b22.js";import{g as we}from"./AnimalType-4489de17.js";import{l as Se,s as Ce,n as $e}from"./formSchema-ea7f1a00.js";import"./SelectedIhcCommissionedItemPanel-70429422.js";import"./LocationService-438c0953.js";import"./LocationDbSimulator-1334c689.js";const ke={class:"list-group"},Le={class:"breadcrumb"},Te={class:"breadcrumb-item"},Ie={class:"breadcrumb-item"},Ae={key:0,class:"breadcrumb-item"},Ne={key:1,class:"breadcrumb-item"},xe={class:"breadcrumb-item"},Ee={class:"breadcrumb-item"},De=G({inheritAttrs:!1,__name:"CompletedLivingForm",props:{livingForm:{}},setup(_){const c=_,r=P(()=>de(c.livingForm.iacucProtocol));return(v,f)=>{const d=w("AppDownloadLink");return b(),S("div",ce(me(v.$attrs)),[e("ul",ke,[(b(!0),S(V,null,Y(v.livingForm.deliveries,(p,k)=>(b(),S("li",{class:"list-group-item bg-info mb-1",key:k},[e("ol",Le,[e("li",Te," 品系: "+F(p.strain==="ratOther"?p.ratOtherStrain:p.strain==="miceOther"?p.miceOtherStrain:p.strain),1),e("li",Ie,"週齡: "+F(p.age),1),p.maleQty?(b(),S("li",Ae,"公: "+F(p.maleQty||0),1)):N("",!0),p.femaleQty?(b(),S("li",Ne,"母: "+F(p.femaleQty||0),1)):N("",!0),e("li",xe,"送來的籠數: "+F(p.sendingCagesQty),1),e("li",Ee,"實驗籠數: "+F(p.expCage),1)])]))),128))]),a(M,{label:"物種"},{content:h(()=>[L(F(l(we)(v.livingForm.animalType)),1)]),_:1}),a(M,{label:"預計運送動物日期"},{content:h(()=>[L(F(v.livingForm.animalArrivalDate),1)]),_:1}),a(M,{label:"預計運送動物時間"},{content:h(()=>[L(F(v.livingForm.animalArrivalTime==="morning"?"上午9:00~12:00":"下午13:30~16:30"),1)]),_:1}),a(M,{label:"IACUC Number"},{content:h(()=>[L(F(v.livingForm.iacucNo),1)]),_:1}),a(M,{label:"IACUC Protocol"},{content:h(()=>[a(d,{name:r.value.name,value:r.value.value},null,8,["name","value"])]),_:1}),a(M,{label:"Note"},{content:h(()=>[L(F(v.livingForm.note),1)]),_:1})],16)}}}),z=_=>{for(let c in _)if(_.hasOwnProperty(c)){let r=_[c];typeof r=="object"&&r!==null&&!Array.isArray(r)?(z(r),Object.keys(r).length===0&&delete _[c]):Array.isArray(r)?r.length===0&&delete _[c]:(r===""||r===null||r===void 0)&&delete _[c]}return _},Oe={class:"mt-4"},Ve=e("h5",{class:"mb-0"},"填寫動物入室資料",-1),Be={class:"row mb-3"},Me=e("label",{for:"iacucfile",class:"col-sm-2 col-form-label"},"選擇表單來源",-1),Re={class:"col-8 mb-3"},Pe={class:"input-group"},Ue={class:"row mb-3"},Qe={class:"d-flex flex-row-reverse mt-2"},Ge={class:"nav nav-tabs",id:"myTab",role:"tablist"},Ze=["id","data-bs-target","aria-controls"],je={class:"tab-content"},ze=["id","aria-labelledby","tabindex"],Ye={class:"mt-2 d-flex flex-row-reverse"},Xe=["onClick"],qe=["onClick"],Ke={class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},We=G({__name:"LivingFormEditingZone",props:{livingForms:{},bindingCageNumber:{type:Boolean},showCellLineInfoFrom:{type:Boolean},showMedicationInfoFrom:{type:Boolean},formSourceVisibility:{type:Boolean,default:!0}},emits:["saveLivingForm","addLivingForm","updateLivingForm","deleteForm"],async setup(_,{emit:c}){let r,v;const f=_,d=c,p=le.getInstance(),k=([r,v]=pe(()=>p.fetchFormSourceOptions()),r=await r,v(),r),o=A(!1),s=A(-1),u={deliveries:[{}],showMedicationInfoFrom:f.showMedicationInfoFrom,showCellLineInfoFrom:f.showCellLineInfoFrom},{handleSubmit:g,values:y,resetForm:C,errors:x}=oe({initialValues:u,validationSchema:Se});ne("errors",x);function i(m={deliveries:[{strain:"",ratOtherStrain:"",miceStrainOther:"",special:"",specialExplain:"",age:"",maleQty:0,femaleQty:0,sendingCagesQty:0,expCage:0}]}){C({values:m},{force:!0})}const E=g(m=>{var D,O,I;const t=K.cloneDeep(m);t.pathologicalExp!=="Y"?(delete t.blood,delete t.tissueSection,delete t.ihc,delete t.slideScanning,delete t.histopathology):((D=t.pathologicalExpType)!=null&&D.includes("TissueSection")||delete t.tissueSection,(O=t.pathologicalExpType)!=null&&O.includes("ihc")||delete t.ihc,(I=t.pathologicalExpType)!=null&&I.includes("Blood")||delete t.blood),t.id=ue(),d("addLivingForm",z(t)),i(u)}),Z=g(m=>{var D,O,I;const t=K.cloneDeep(m);t.pathologicalExp!=="Y"?(delete t.blood,delete t.tissueSection,delete t.ihc,delete t.slideScanning,delete t.histopathology):((D=t.pathologicalExpType)!=null&&D.includes("TissueSection")||delete t.tissueSection,(O=t.pathologicalExpType)!=null&&O.includes("ihc")||delete t.ihc,(I=t.pathologicalExpType)!=null&&I.includes("Blood")||delete t.blood),d("updateLivingForm",{form:z(t),index:s.value}),i(),s.value=-1,o.value=!1}),Q=m=>{o.value=!0,s.value=m;const t=f.livingForms[m];i(t),window.scrollTo({top:100,behavior:"smooth"})},ie=m=>{d("deleteForm",m),o.value=!1,s.value=m},ae=()=>{d("saveLivingForm")};function te(){s.value=-1,o.value=!1;const m=p.fetchLivingForm(y.formSource);i(m)}const se=P(()=>{const m=Object.keys(x.value).length;return m!==0?`尚有${m}個項目未填寫`:""});return(m,t)=>{var X,q;const D=w("AppFloatingMessage"),O=w("AppSelect"),I=w("AppCard");return b(),S(V,null,[a(D,{message:se.value},null,8,["message"]),e("form",Oe,[a(I,{class:"mt-4"},{header:h(()=>[Ve]),body:h(()=>[R(e("div",Be,[Me,e("div",Re,[e("div",Pe,[a(O,{name:"formSource",options:l(k),onChange:t[0]||(t[0]=T=>te()),"default-option":!1,value:"new"},null,8,["options"])])])],512),[[j,m.formSourceVisibility]]),e("div",Ue,[a(ye,{"binding-cage-number":m.bindingCageNumber,"show-cell-line-info-from":m.showCellLineInfoFrom,"show-medication-info-from":m.showMedicationInfoFrom,values:l(y)},null,8,["binding-cage-number","show-cell-line-info-from","show-medication-info-from","values"]),e("div",Qe,[R(e("button",{class:"btn btn-primary",type:"button",onClick:t[1]||(t[1]=(...T)=>l(Z)&&l(Z)(...T))}," 修改 ",512),[[j,o.value]]),R(e("button",{class:"btn btn-info text-white",type:"button",onClick:t[2]||(t[2]=(...T)=>l(E)&&l(E)(...T))}," 填寫完畢 ",512),[[j,!o.value]])])])]),_:1}),(X=m.livingForms)!=null&&X.length?(b(),U(I,{key:0,class:"mt-2"},{title:h(()=>[L(" 已填寫入室申請表 ")]),body:h(()=>[e("ul",Ge,[(b(!0),S(V,null,Y(m.livingForms,(T,$)=>(b(),S("li",{class:"nav-item",role:"presentation",key:T.id},[e("button",{class:W(["nav-link",{active:$===0}]),id:`homeTab${$}`,"data-bs-toggle":"tab","data-bs-target":`#tabPanel${$}`,type:"button",role:"tab","aria-controls":`tabPanel${$}`,"aria-selected":"true"}," #"+F($+1),11,Ze)]))),128))]),e("div",je,[(b(!0),S(V,null,Y(m.livingForms,(T,$)=>(b(),S("div",{class:W(["tab-pane p-2",{active:$===0}]),id:`tabPanel${$}`,role:"tabpanel","aria-labelledby":`homeTab${$}`,tabindex:$,key:T.id},[a(De,{livingForm:T},null,8,["livingForm"]),e("div",Ye,[e("button",{type:"button",class:"btn btn-secondary",onClick:H(re=>Q($),["prevent"])}," 編輯 ",8,Xe),e("button",{type:"button",class:"btn btn-danger mx-1",onClick:H(re=>ie($),["prevent"])}," 刪除 ",8,qe)])],10,ze))),128))])]),_:1})):N("",!0),e("div",Ke,[R(e("button",{type:"button",class:"btn btn-primary",onClick:ae}," 下一步 ",512),[[j,(q=m.livingForms)==null?void 0:q.length]])])])],64)}}}),He={class:"row mb-3"},Je=["for"],eo={class:"col-8"},oo={class:"row mb-3"},lo=["for"],no={class:"col-8"},io={class:"row mb-3"},ao=["for"],to={class:"col-8"},so={class:"row mb-3"},ro=["for"],co={class:"col-8"},mo={class:"row mb-3"},po=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star"},"實驗類型",-1),uo={class:"col-sm-10"},vo={class:"row mb-3"},fo=["for"],ho={class:"col-8"},bo=e("i",{class:"bi bi-cloud-download"},null,-1),go=[bo],_o={id:"radiologyRelated"},yo={class:"row mb-3"},Fo=["for"],wo={class:"col-8"},So={class:"row mb-3"},Co=["for"],$o={class:"col-8"},ko={class:"row mb-3"},Lo=["for"],To={class:"col-8"},Io={class:"row mb-3"},Ao=["for"],No={class:"col-8"},xo={class:"row mb-3"},Eo=["for"],Do={class:"col-8"},Oo={id:"otherRelated"},Vo={class:"row mb-3"},Bo=["for"],Mo={class:"col-8"},Ro={class:"row mb-3"},Po=["for"],Uo={class:"col-8"},Qo={class:"row mb-3"},Go=["for"],Zo={class:"col-8"},jo={class:"row mb-3"},zo=["for"],Yo={class:"col-8"},Xo={class:"row mb-3"},qo=["for"],Ko={class:"col-8"},Wo=G({__name:"NonLivingForm",props:{values:{},prefix:{default:()=>""}},setup(_){const c=_,{loggedInUser:r}=ve(fe()),v=o=>c.values.experimentType!==void 0&&c.values.experimentType.includes(o),f=P(()=>{var o;return c.values.contact?c.values.contact:(o=r.value)==null?void 0:o.title}),d=P(()=>{var o;return c.values.contactTel?c.values.contactTel:(o=r.value)==null?void 0:o.phone}),p=P(()=>{var o;return c.values.contactEmail?c.values.contactEmail:(o=r.value)==null?void 0:o.username}),k=()=>{let s="data:text/csv;charset=utf-8,"+[["No.","Sample ID (只可填入14字元，包括空格及標點符號)"],["",""]].map(y=>y.join(",")).join(`
`);var u=encodeURI(s),g=document.createElement("a");g.setAttribute("href",u),g.setAttribute("download","sample.csv"),document.body.appendChild(g),g.click()};return(o,s)=>{const u=w("AppInput"),g=w("AppCheckbox"),y=w("AppDownloadFileInput"),C=w("AppBlock"),x=w("AppRadio"),i=w("AppRadioInput");return b(),S(V,null,[e("div",He,[e("label",{for:l(n)(o.prefix,"contact"),class:"col-sm-2 col-form-label red-star"},"申請者姓名",8,Je),e("div",eo,[a(u,{name:l(n)(o.prefix,"contact"),value:f.value},null,8,["name","value"])])]),e("div",oo,[e("label",{for:l(n)(o.prefix,"contactTel"),class:"col-sm-2 col-form-label red-star"},"申請者電話",8,lo),e("div",no,[a(u,{name:l(n)(o.prefix,"contactTel"),value:d.value},null,8,["name","value"])])]),e("div",io,[e("label",{for:l(n)(o.prefix,"contactEmail"),class:"col-sm-2 col-form-label red-star"},"申請者信箱",8,ao),e("div",to,[a(u,{type:"email",name:l(n)(o.prefix,"contactEmail"),value:p.value},null,8,["name","value"])])]),e("div",so,[e("label",{for:l(n)(o.prefix,"scheduledDeliveryDate"),class:"col-sm-2 col-form-label red-star"},"約定的送件日期",8,ro),e("div",co,[a(u,{type:"date",name:l(n)(o.prefix,"scheduledDeliveryDate")},null,8,["name"])])]),e("fieldset",mo,[po,e("div",uo,[a(g,{label:"病理學",name:l(n)(o.prefix,"experimentType"),id:l(n)(o.prefix,"experimentTypePathology"),"checked-value":"pathology"},null,8,["name","id"]),a(g,{label:"斷層掃描",name:l(n)(o.prefix,"experimentType"),id:l(n)(o.prefix,"experimentTypeRadiology"),"checked-value":"radiology"},null,8,["name","id"]),a(g,{label:"其它",name:l(n)(o.prefix,"experimentType"),id:l(n)(o.prefix,"experimentTypeOther"),"checked-value":"other"},null,8,["name","id"])])]),v("pathology")?(b(),U(C,{key:0,class:"my-2"},{title:h(()=>[L(" 病理學 ")]),content:h(()=>[e("div",vo,[e("label",{for:l(n)(o.prefix,"uploadedSampleSheetFile"),class:"col-sm-2 col-form-label red-star"},"上傳檢體編號表",8,fo),e("div",ho,[a(y,{name:l(n)(o.prefix,"uploadedSampleSheetFile"),schema:l(Ce)},null,8,["name","schema"]),e("div",null,[L(" 檢體編號表範本"),e("a",{href:"#",onClick:k},go)])])]),a(Fe,{prefix:o.prefix,values:o.values,visible:v("pathology")},null,8,["prefix","values","visible"])]),_:1})):N("",!0),v("radiology")?(b(),U(C,{key:1,class:"my-2"},{title:h(()=>[L(" 影像學 ")]),content:h(()=>[e("div",_o,[e("div",yo,[e("label",{for:l(n)(o.prefix,"radiology.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,Fo),e("div",wo,[a(u,{id:l(n)(o.prefix,"radiology.sampleNumber"),type:"number",name:l(n)(o.prefix,"radiology.sampleNumber")},null,8,["id","name"])])]),e("div",So,[e("label",{for:l(n)(o.prefix,"radiology.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,Co),e("div",$o,[a(u,{type:"text",id:l(n)(o.prefix,"radiology.sampleId"),name:l(n)(o.prefix,"radiology.sampleId")},null,8,["id","name"])])]),e("div",ko,[e("label",{for:l(n)(o.prefix,"radiology.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,Lo),e("div",To,[a(x,{name:l(n)(o.prefix,"radiology.sampleType"),id:l(n)(o.prefix,"radiology.sampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),a(i,{label:"其他",id:l(n)(o.prefix,"radiologyOtherSampleType"),"radio-name":l(n)(o.prefix,"radiology.sampleType"),"checked-value":"other","input-name":l(n)(o.prefix,"radiology.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",Io,[e("label",{for:l(n)(o.prefix,"radiology.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,Ao),e("div",No,[a(y,{name:l(n)(o.prefix,"radiology.attachment")},null,8,["name"])])]),e("div",xo,[e("label",{for:l(n)(o.prefix,"radiology.note"),class:"col-sm-2 col-form-label"},"備註",8,Eo),e("div",Do,[a(u,{type:"text",id:l(n)(o.prefix,"radiology.note"),name:l(n)(o.prefix,"radiology.note")},null,8,["id","name"])])])])]),_:1})):N("",!0),v("other")?(b(),U(C,{key:2,class:"my-2"},{title:h(()=>[L(" 其他 ")]),content:h(()=>[e("div",Oo,[e("div",Vo,[e("label",{for:l(n)(o.prefix,"other.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,Bo),e("div",Mo,[a(u,{id:l(n)(o.prefix,"other.sampleNumber"),type:"number",name:l(n)(o.prefix,"other.sampleNumber")},null,8,["id","name"])])]),e("div",Ro,[e("label",{for:l(n)(o.prefix,"other.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,Po),e("div",Uo,[a(u,{type:"text",id:l(n)(o.prefix,"other.sampleId"),name:l(n)(o.prefix,"other.sampleId")},null,8,["id","name"])])]),e("div",Qo,[e("label",{for:l(n)(o.prefix,"other.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,Go),e("div",Zo,[a(x,{name:l(n)(o.prefix,"other.sampleType"),id:l(n)(o.prefix,"otherSampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),a(i,{label:"其他",id:l(n)(o.prefix,"otherOtherSampleType"),"radio-name":l(n)(o.prefix,"other.sampleType"),"checked-value":"other","input-name":l(n)(o.prefix,"other.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",jo,[e("label",{for:l(n)(o.prefix,"other.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,zo),e("div",Yo,[a(y,{name:l(n)(o.prefix,"other.attachment")},null,8,["name"])])]),e("div",Xo,[e("label",{for:l(n)(o.prefix,"other.note"),class:"col-sm-2 col-form-label"},"備註",8,qo),e("div",Ko,[a(u,{type:"text",id:l(n)(o.prefix,"other.note"),name:l(n)(o.prefix,"other.note")},null,8,["id","name"])])])])]),_:1})):N("",!0)],64)}}}),Ho=e("h5",{class:"mb-0"},"填寫非活體資料",-1),Jo=e("div",{class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},[e("button",{type:"submit",class:"btn btn-primary"},"下一步")],-1),el=G({__name:"NonLivingFormEditingZone",props:{nonLivingForm:{}},emits:["saveNonLivingForm"],setup(_,{emit:c}){const r=_,v=c,{handleSubmit:f,values:d,errors:p}=oe({initialValues:r.nonLivingForm,validationSchema:$e});ne("errors",p);const k=f(s=>{var u,g,y,C;(u=s.experimentType)!=null&&u.includes("pathology")?((g=s.pathologicalExpType)!=null&&g.includes("TissueSection")||delete s.tissueSection,(y=s.pathologicalExpType)!=null&&y.includes("ihc")||delete s.ihc,(C=s.pathologicalExpType)!=null&&C.includes("Blood")||delete s.blood):(delete s.blood,delete s.tissueSection,delete s.ihc,delete s.slideScanning,delete s.histopathology),v("saveNonLivingForm",z(s))}),o=P(()=>{const s=Object.keys(p.value).length;return s!==0?`尚有${s}個項目未填寫`:""});return(s,u)=>{const g=w("AppFloatingMessage"),y=w("AppCard");return b(),S(V,null,[a(g,{message:o.value},null,8,["message"]),e("form",{id:"nonLivingFormEditingZone",onSubmit:u[0]||(u[0]=(...C)=>l(k)&&l(k)(...C)),class:"mt-4"},[a(y,{class:"mt-4"},{header:h(()=>[Ho]),body:h(()=>[a(Wo,{values:l(d)},null,8,["values"])]),_:1}),Jo],32)],64)}}}),ol=e("h4",{class:"fw-bold py-3 mb-4"},"實驗類型",-1),ll=e("h5",{class:"mb-0"},"活體/非活體",-1),nl={class:"form-check form-check-inline"},il=["value"],al={class:"form-check-label",for:"living"},tl={class:"form-check form-check-inline"},sl=["value"],rl={class:"form-check-label",for:"nonLiving"},bl=G({__name:"ExpApplicationStep2",props:{id:{}},setup(_){const c=_,r=le.getInstance(),v=he(),f=A(),d=A(),p=A(),k=A(!1),o=A(!1),s=A(!1);be(async()=>{await r.loadDataForStep2(c.id).then(i=>{f.value=i==null?void 0:i.sampleCategory,d.value=(i==null?void 0:i.livingForms)===void 0?[]:i.livingForms,p.value=i==null?void 0:i.nonLivingForm,k.value=i==null?void 0:i.bindingCageNumber,o.value=(i==null?void 0:i.showCellLineInfoFrom)||!1,s.value=(i==null?void 0:i.showMedicationInfoFrom)||!1}).catch(i=>{console.log(i)})});const u=async()=>{f.value&&d.value&&await r.saveLivingForms(c.id,f.value,d.value).then(()=>{v.proceedToStep3(c.id)})},g=i=>{d.value===void 0&&(d.value=[]),d.value.push(i)},y=i=>{d.value===void 0&&(d.value=[]),d.value[i.index]=i.form},C=i=>{d.value&&d.value.splice(i,1)},x=async i=>{f.value&&await r.saveNonLivingForm(c.id,f.value,i).then(()=>{v.proceedToStep4(c.id)})};return(i,E)=>{const Z=w("AppCard");return b(),S(V,null,[ol,a(_e,{"notification-type":l(ge).EXP_CASE,"entity-id":i.id},null,8,["notification-type","entity-id"]),a(Z,null,{header:h(()=>[ll]),body:h(()=>[e("div",nl,[R(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:l(B).LIVING,id:"living","onUpdate:modelValue":E[0]||(E[0]=Q=>f.value=Q)},null,8,il),[[J,f.value]]),e("label",al,F(l(ee)(l(B).LIVING)),1)]),e("div",tl,[R(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:l(B).NON_LIVING,id:"nonLiving","onUpdate:modelValue":E[1]||(E[1]=Q=>f.value=Q)},null,8,sl),[[J,f.value]]),e("label",rl,F(l(ee)(l(B).NON_LIVING)),1)])]),_:1}),f.value===l(B).LIVING?(b(),U(We,{key:0,"binding-cage-number":k.value,"living-forms":d.value?d.value:[],"show-medication-info-from":s.value,"show-cell-line-info-from":o.value,onSaveLivingForm:u,onAddLivingForm:g,onUpdateLivingForm:y,onDeleteForm:C},null,8,["binding-cage-number","living-forms","show-medication-info-from","show-cell-line-info-from"])):N("",!0),f.value===l(B).NON_LIVING?(b(),U(el,{key:1,"non-living-form":p.value,onSaveNonLivingForm:x},null,8,["non-living-form"])):N("",!0)],64)}}});export{bl as default};
