import{d as W,aF as de,o as c,i as v,k as a,a0 as me,m as h,n as ue,aG as pe,u as ve,K as _e,aC as he,r as p,f as w,c as be,aH as Y,h as _,C as z,A as G,j as e,w as C,B as R,l as g,v as j,F as B,z as q,t as I,E as H,W as ge}from"./index-c3923e02.js";import{m as ye,n as K,o as fe,p as Se,q as Ce,r as Ie,s as xe,t as ke}from"./api-9f51bc32.js";import{u as Fe}from"./FormSchemaStore-2dcac12c.js";const we=W({__name:"AppSelectUser",props:{name:{},options:{default:()=>[]}},setup(T){const A=T,{value:n,errorMessage:M,handleBlur:N,handleChange:r}=de(()=>A.name,void 0),d=m=>{r(m.map(i=>i.value))};return(m,i)=>(c(),v("div",null,[a(h(pe),me({class:["form-control",{"is-invalid":h(M)?"is-invalid":""}],options:m.options,placeholder:"請選擇",label:"name",reduce:y=>y.id,onBlur:h(N),"onOption:selected":d},m.$attrs,{modelValue:h(n),"onUpdate:modelValue":i[0]||(i[0]=y=>ue(n)?n.value=y:null),multiple:""}),null,16,["class","options","reduce","onBlur","modelValue"])]))}}),Be={class:"row mb-2"},Te=e("label",{for:"labType",class:"col-sm-2 col-form-label red-star"},"單位 ",-1),Ae={class:"col-sm-4"},Me={class:"row mb-2"},Ne=e("label",{for:"code",class:"col-sm-2 col-form-label red-star"},"Service Item Code ",-1),Ue={class:"col-sm-4"},Ve={class:"row mb-2"},Le=e("label",{for:"name",class:"col-sm-2 col-form-label red-star"},"Service Item Name ",-1),Re={class:"col-sm-9"},je={class:"row mb-2"},qe=e("label",{for:"note",class:"col-sm-2 col-form-label"},"Note",-1),De={class:"col-sm-9"},Ee={class:"row mb-2"},Pe=e("label",{for:"type",class:"col-sm-2 col-form-label red-star"},"服務項目類別",-1),$e={class:"col-sm-4",id:"type"},Oe={class:"input-group"},Ye=e("label",{class:"input-group-text",for:"serviceCategory"},"大類",-1),ze={class:"col-sm-4"},Ge={class:"input-group"},He=e("label",{class:"input-group-text",for:"serviceSubCategory"},"小類",-1),Ke={class:"row mb-2"},We=e("label",{for:"owner",class:"col-sm-2 col-form-label red-star"},"負責人",-1),Xe={class:"col-sm-9"},Je={class:"row mb-2"},Qe=e("label",{for:"firstItemUnit",class:"col-sm-2 col-form-label red-star"},"Sample amount 之單位 ",-1),Ze={class:"col-3"},et={class:"col-3"},tt={class:"row mb-2"},st=e("label",{for:"sampleCategory",class:"col-sm-2 col-form-label red-star"},"樣本種類",-1),at={class:"col-sm-8"},ot={class:"row mb-2"},lt=e("label",{for:"externalCharge",class:"col-sm-2 col-form-label"},"外界單位收費(產)",-1),nt={class:"col-sm-9"},it={class:"row mb-2"},ct=e("label",{for:"exchangeRate",class:"col-sm-2 col-form-label"},"匯率",-1),rt={class:"col-sm-9"},dt={class:"row mb-2"},mt=e("label",{for:"academicServiceItemFee",class:"col-sm-2 col-form-label red-star"},"學術費用",-1),ut={class:"col-sm-4"},pt={class:"row mb-2"},vt=e("label",{for:"industryServiceItemFee",class:"col-sm-2 col-form-label red-star"},"產業界費用",-1),_t={class:"col-sm-4"},ht={class:"row mb-2"},bt=e("legend",{class:"col-form-label col-sm-2 pt-0"},"是否允許扣除餘額",-1),gt={class:"col-sm-9"},yt={class:"row mb-2"},ft=e("legend",{class:"col-form-label col-sm-2 pt-0"},"是否可自行填寫金額",-1),St={class:"col-sm-9"},Ct={class:"d-flex justify-content-between"},It=e("button",{type:"button",class:"btn btn-primary","data-bs-toggle":"modal","data-bs-target":"#modalCenter"}," 設定儀器 ",-1),xt={class:"table table-borderless"},kt={class:"mt-2 d-flex justify-content-between flex-row-reverse"},Ft=["disabled"],wt={key:0,type:"button",class:"btn btn-danger mx-1","data-bs-toggle":"modal","data-bs-target":"#exampleModal"},Bt={class:"modal fade",id:"modalCenter",tabindex:"-1","aria-hidden":"true"},Tt={class:"modal-dialog modal-dialog-centered",role:"document"},At={class:"modal-content"},Mt=e("div",{class:"modal-header"},[e("h5",{class:"modal-title",id:"modalCenterTitle"},"選擇儀器"),e("button",{type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})],-1),Nt={class:"modal-body"},Ut={class:"input-group my-2"},Vt=e("span",{class:"input-group-text",id:"basic-addon1"},"Search",-1),Lt={class:"list-group"},Rt=e("li",{style:{"list-style-type":"none"}},[e("small",{class:"text-danger d-flex justify-content-end"},"最多小數點第二位")],-1),jt={class:"row"},qt={class:"col-1"},Dt=["onUpdate:modelValue"],Et={class:"col-7"},Pt={class:"text-wrap instrumentName"},$t={class:"col-4"},Ot={class:"input-group input-group-sm input-group-merge"},Yt=["onUpdate:modelValue"],zt=e("span",{class:"input-group-text"},"%",-1),Gt=e("div",{class:"modal-body"},"確定刪除?",-1),Ht=e("button",{type:"button",class:"btn btn-secondary","data-bs-dismiss":"modal"},"關閉",-1),Qt=W({__name:"ServiceItemComponent",props:{initialServiceItem:{type:Object,required:!1,default:()=>{}},initialInstruments:{type:Array,required:!1,default:()=>[]}},setup(T){const A=ve(),n=T;_e(async()=>{var t;(t=n.initialServiceItem)!=null&&t.labType&&(await ye(n.initialServiceItem.labType).then(s=>{m.value=s.map(o=>({id:o.id,name:o.chineseName,value:o.id}))}),await K(n.initialServiceItem.serviceCategory).then(s=>{i.value=s.map(o=>({id:o.id,name:o.chineseName,value:o.id}))}),await fe(n.initialServiceItem.labType).then(s=>{x.value=s.map(o=>({id:o.id,name:o.name,value:o.id}))}))});const{serviceItemCreationFormSchema:M}=Fe(),N=he().map(t=>({id:t.id,name:t.name,value:t.id})),r=p(""),d=p(!1),m=p([]),i=p([]),y=p(Ie()),f=p(n.initialInstruments),x=p([]),k=p(""),D=w(()=>f.value.filter(t=>t.checked).reduce((t,s)=>t+Number(s.percentage),0)),b=w(()=>f.value.filter(t=>t.checked)),X=w(()=>f.value.filter(t=>k.value?t.name.includes(k.value):!0)),U=w(()=>b.value.length===0?!0:b.value.length!==0&&ne()),{handleSubmit:J,values:E,errors:Kt,defineField:F,resetForm:Q}=be({validationSchema:M,initialValues:n.initialServiceItem}),[Z]=F("checkServiceSubCategory"),[ee]=F("serviceSubCategory"),[te]=F("labType"),[se]=F("serviceCategory");Y(te,(t,s)=>{t&&t!==s&&ae()}),Y(se,(t,s)=>{t&&t!==s&&(oe(),ee.value=void 0)});const ae=()=>{ke(E.labType).then(t=>{var s;m.value=(s=t[0])==null?void 0:s.map(o=>({id:o.id,name:o.chineseName,value:o.id})),f.value=t[1],x.value=t[2].map(o=>({id:o.id,name:o.name,value:o.id}))}).catch(t=>{m.value.length=0})},oe=()=>{K(E.serviceCategory).then(t=>{i.value=t.map(s=>({id:s.id,name:s.chineseName,value:s.id})),Z.value=t.length!==0}).catch(t=>{i.value.length=0})},le=()=>`比例總和為${D.value}%，少於或超過100%，請重新調整比例`,ne=()=>D.value==100,P=J(async t=>{if(U.value)if(n.initialServiceItem)try{const s=await Ce(t,b.value);d.value=!0,r.value=s}catch(s){d.value=!1,r.value=s.message}else try{const s=await Se(t,b.value);d.value=!0,r.value=s,Q(),x.value.length=0,f.value.length=0}catch(s){d.value=!1,r.value=s.message}}),ie=()=>{xe(n.initialServiceItem.id).then(t=>{d.value=!0,A.push({name:"ServiceItemManagement",params:{message:t}})}).catch(t=>{d.value=!1,r.value="刪除失敗"})};return(t,s)=>{var O;const o=_("AppMessage"),V=_("AppSelect"),u=_("AppInput"),ce=_("AppTextarea"),S=_("AppRadio"),$=_("AppCard"),re=_("router-link");return c(),v(B,null,[r.value?(c(),z(o,{key:0,message:r.value,success:d.value},null,8,["message","success"])):G("",!0),e("form",{onSubmit:s[0]||(s[0]=(...l)=>h(P)&&h(P)(...l))},[a($,null,{header:C(()=>[R(" 服務項目 ")]),body:C(()=>[e("div",Be,[Te,e("div",Ae,[a(V,{id:"labType",name:"labType",options:h(N)},null,8,["options"])])]),e("div",Me,[Ne,e("div",Ue,[a(u,{name:"code"})])]),e("div",Ve,[Le,e("div",Re,[a(u,{name:"name"})])]),e("div",je,[qe,e("div",De,[a(ce,{name:"note"})])]),e("div",Ee,[Pe,e("div",$e,[e("div",Oe,[Ye,a(V,{id:"serviceCategory",name:"serviceCategory",options:m.value},null,8,["options"])])]),g(e("div",ze,[e("div",Ge,[He,a(u,{name:"checkServiceSubCategory",type:"hidden"}),a(V,{id:"serviceSubCategory",name:"serviceSubCategory",options:i.value},null,8,["options"])])],512),[[j,i.value.length]])]),e("div",Ke,[We,e("div",Xe,[a(we,{name:"owners",options:x.value},null,8,["options"])])]),e("div",Je,[Qe,e("div",Ze,[a(u,{name:"firstItemUnit"})]),R(" * "),e("div",et,[a(u,{name:"secondItemUnit"})])]),e("div",tt,[st,e("div",at,[(c(!0),v(B,null,q(y.value,l=>(c(),z(S,{id:l.name,name:"sampleCategory",label:l.description,"checked-value":l.name,key:l},null,8,["id","label","checked-value"]))),128))])]),e("div",ot,[lt,e("div",nt,[a(u,{type:"number",min:"0",name:"externalCharge"})])]),e("div",it,[ct,e("div",rt,[a(u,{type:"number",min:"0",name:"exchangeRate"})])]),e("div",dt,[mt,e("div",ut,[a(u,{type:"number",min:"0",name:"academicServiceItemFee"})])]),e("div",pt,[vt,e("div",_t,[a(u,{type:"number",min:"0",name:"industryServiceItemFee"})])]),e("fieldset",ht,[bt,e("div",gt,[a(S,{id:"deductionFromBalanceY",name:"deductionFromBalance",label:"是","checked-value":!0}),a(S,{id:"deductionFromBalanceN",name:"deductionFromBalance",label:"否","checked-value":!1})])]),e("fieldset",yt,[ft,e("div",St,[a(S,{id:"fillFeeManuallyY",name:"fillFeeManually",label:"是","checked-value":!0}),a(S,{id:"fillFeeManuallyN",name:"fillFeeManually",label:"否","checked-value":!1})])])]),_:1}),a($,{class:"mt-3"},{header:C(()=>[e("div",Ct,[It,g(e("span",{class:"text-danger"},I(le()),513),[[j,!U.value]])])]),body:C(()=>[g(e("table",xt,[e("tbody",null,[(c(!0),v(B,null,q(b.value,l=>(c(),v("tr",{key:l.id},[e("td",null,I(l.name),1),e("td",null,I(l.percentage)+"%",1)]))),128))])],512),[[j,b.value.length]])]),_:1}),e("div",kt,[e("button",{type:"submit",class:"btn btn-primary",disabled:!U.value},I(n.initialServiceItem?"更新":"建立"),9,Ft),(O=n.initialServiceItem)!=null&&O.deletable?(c(),v("button",wt," 刪除 ")):G("",!0),a(re,{to:{name:"ServiceItemManagement"},class:"btn btn-outline-secondary"},{default:C(()=>[R("回到服務項目管理")]),_:1})])],32),e("div",Bt,[e("div",Tt,[e("div",At,[Mt,e("div",Nt,[e("div",Ut,[Vt,g(e("input",{id:"filter",type:"text",class:"form-control","onUpdate:modelValue":s[1]||(s[1]=l=>k.value=l)},null,512),[[H,k.value]])]),e("ul",Lt,[Rt,(c(!0),v(B,null,q(X.value,l=>(c(),v("li",{class:"list-group-item instrument",key:l.id},[e("div",jt,[e("div",qt,[g(e("input",{type:"checkbox","onUpdate:modelValue":L=>l.checked=L},null,8,Dt),[[ge,l.checked]])]),e("div",Et,[e("span",Pt,I(l.name),1)]),e("div",$t,[e("div",Ot,[g(e("input",{type:"number",min:"0",max:"100",step:"0.01",class:"form-control",onblur:"this.value=Number.parseFloat(this.value).toFixed(2);","onUpdate:modelValue":L=>l.percentage=L},null,8,Yt),[[H,l.percentage]]),zt])])])]))),128))])])])])]),e("div",{class:"modal fade",id:"exampleModal",tabindex:"-1","aria-labelledby":"exampleModalLabel","aria-hidden":"true"},[e("div",{class:"modal-dialog"},[e("div",{class:"modal-content"},[Gt,e("div",{class:"modal-footer"},[Ht,e("button",{type:"button",class:"btn btn-primary","data-bs-dismiss":"modal",onClick:ie}," 確定 ")])])])])],64)}}});export{Qt as _};
