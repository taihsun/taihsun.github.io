import{d as R,c as B,e as w,o as h,f as S,g as e,F as x,x as G,t as _,y as N,h as n,w as f,z as L,j as o,U as ae,V as re,W as ce,q as K,s as me,r as A,a as W,m as j,H as de,i as V,v as U,B as M,X,n as z,Y,M as pe,K as ue,Z as t,$ as ve,a0 as q}from"./index-501cd1c4.js";import{S as D,g as H}from"./SampleCategory-297f54b4.js";import{a as O,_ as fe,b as he}from"./LivingForm.vue_vue_type_script_setup_true_lang-16a6fa72.js";import{g as be}from"./SelectedIhcCommissionedItemPanel-54c59095.js";import{l as ge,s as _e,n as ye}from"./formSchema-64a74bbf.js";import"./LocationService-d3f74d48.js";const Fe={class:"list-group"},we={class:"breadcrumb"},Se={class:"breadcrumb-item"},Ce={class:"breadcrumb-item"},$e={key:0,class:"breadcrumb-item"},ke={key:1,class:"breadcrumb-item"},Le={class:"breadcrumb-item"},Te={class:"breadcrumb-item"},Ie=R({inheritAttrs:!1,__name:"CompletedLivingForm",props:{livingForm:{}},setup(b){const c=b,i=B(()=>ce(c.livingForm.iacucProtocol));return(a,u)=>{const y=w("AppDownloadLink");return h(),S("div",ae(re(a.$attrs)),[e("ul",Fe,[(h(!0),S(x,null,G(a.livingForm.deliveries,(p,k)=>(h(),S("li",{class:"list-group-item bg-info mb-1",key:k},[e("ol",we,[e("li",Se," 品系: "+_(p.strain==="ratOther"?p.ratOtherStrain:p.strain==="miceOther"?p.miceOtherStrain:p.strain),1),e("li",Ce,"週齡: "+_(p.age),1),p.maleQty?(h(),S("li",$e,"公: "+_(p.maleQty||0),1)):N("",!0),p.femaleQty?(h(),S("li",ke,"母: "+_(p.femaleQty||0),1)):N("",!0),e("li",Le,"送來的籠數: "+_(p.sendingCagesQty),1),e("li",Te,"實驗籠數: "+_(p.expCage),1)])]))),128))]),n(O,{label:"物種"},{content:f(()=>[L(_(o(be)(a.livingForm.animalType)),1)]),_:1}),n(O,{label:"預計運送動物日期"},{content:f(()=>[L(_(a.livingForm.animalArrivalDate),1)]),_:1}),n(O,{label:"預計運送動物時間"},{content:f(()=>[L(_(a.livingForm.animalArrivalTime==="morning"?"上午9:00~12:00":"下午13:30~16:30"),1)]),_:1}),n(O,{label:"IACUC Number"},{content:f(()=>[L(_(a.livingForm.iacucNo),1)]),_:1}),n(O,{label:"IACUC Protocol"},{content:f(()=>[n(y,{name:i.value.name,value:i.value.value},null,8,["name","value"])]),_:1}),n(O,{label:"Note"},{content:f(()=>[L(_(a.livingForm.note),1)]),_:1})],16)}}}),Q=b=>{for(let c in b)if(b.hasOwnProperty(c)){let i=b[c];typeof i=="object"&&i!==null&&!Array.isArray(i)?(Q(i),Object.keys(i).length===0&&delete b[c]):Array.isArray(i)?i.length===0&&delete b[c]:(i===""||i===null||i===void 0)&&delete b[c]}return b},Ae={class:"mt-4"},Ne=e("h5",{class:"mb-0"},"填寫動物入室資料",-1),xe={class:"row mb-3"},Ee=e("label",{for:"iacucfile",class:"col-sm-2 col-form-label"},"選擇表單來源",-1),De={class:"col-8 mb-3"},Oe={class:"input-group"},Ve={class:"row mb-3"},Be={class:"d-flex flex-row-reverse mt-2"},Me={class:"nav nav-tabs",id:"myTab",role:"tablist"},Re=["id","data-bs-target","aria-controls"],Pe={class:"tab-content"},Ue=["id","aria-labelledby","tabindex"],Qe={class:"mt-2 d-flex flex-row-reverse"},Ge=["onClick"],Ze=["onClick"],je={class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},ze=R({__name:"LivingFormEditingZone",props:{livingForms:{},bindingCageNumber:{type:Boolean},showCellLineInfoFrom:{type:Boolean},showMedicationInfoFrom:{type:Boolean},formSourceVisibility:{type:Boolean,default:!0}},emits:["saveLivingForm","addLivingForm","updateLivingForm","deleteForm"],async setup(b,{emit:c}){let i,a;const u=b,y=c,p=K(),k=([i,a]=me(()=>p.fetchFormSourceOptions()),i=await i,a(),i),l=A(!1),r=A(-1),v={deliveries:[{}],showMedicationInfoFrom:u.showMedicationInfoFrom,showCellLineInfoFrom:u.showCellLineInfoFrom},{handleSubmit:g,values:F,resetForm:T,errors:m}=W({initialValues:v,validationSchema:ge});X("errors",m);function C(d={deliveries:[{strain:"",ratOtherStrain:"",miceStrainOther:"",special:"",specialExplain:"",age:"",maleQty:0,femaleQty:0,sendingCagesQty:0,expCage:0}]}){T({values:d},{force:!0})}const P=g(d=>{const s=j.cloneDeep(d);s.pathologicalExp!=="Y"?(delete s.blood,delete s.tissueSection,delete s.ihc,delete s.slideScanning,delete s.histopathology):(s.pathologicalExpType?.includes("TissueSection")||delete s.tissueSection,s.pathologicalExpType?.includes("ihc")||delete s.ihc,s.pathologicalExpType?.includes("Blood")||delete s.blood),s.id=de(),y("addLivingForm",Q(s)),C(v)}),E=g(d=>{const s=j.cloneDeep(d);s.pathologicalExp!=="Y"?(delete s.blood,delete s.tissueSection,delete s.ihc,delete s.slideScanning,delete s.histopathology):(s.pathologicalExpType?.includes("TissueSection")||delete s.tissueSection,s.pathologicalExpType?.includes("ihc")||delete s.ihc,s.pathologicalExpType?.includes("Blood")||delete s.blood),y("updateLivingForm",{form:Q(s),index:r.value}),C(),r.value=-1,l.value=!1}),J=d=>{l.value=!0,r.value=d;const s=u.livingForms[d];C(s),window.scrollTo({top:100,behavior:"smooth"})},ee=d=>{y("deleteForm",d),l.value=!1,r.value=d},oe=()=>{y("saveLivingForm")};function le(){r.value=-1,l.value=!1;const d=p.fetchLivingForm(F.formSource);C(d)}const te=B(()=>{const d=Object.keys(m.value).length;return d!==0?`尚有${d}個項目未填寫`:""});return(d,s)=>{const se=w("AppFloatingMessage"),ne=w("AppSelect"),Z=w("AppCard");return h(),S(x,null,[n(se,{message:te.value},null,8,["message"]),e("form",Ae,[n(Z,{class:"mt-4"},{header:f(()=>[Ne]),body:f(()=>[V(e("div",xe,[Ee,e("div",De,[e("div",Oe,[n(ne,{name:"formSource",options:o(k),onChange:s[0]||(s[0]=I=>le()),"default-option":!1,value:"new"},null,8,["options"])])])],512),[[U,d.formSourceVisibility]]),e("div",Ve,[n(fe,{"binding-cage-number":d.bindingCageNumber,"show-cell-line-info-from":d.showCellLineInfoFrom,"show-medication-info-from":d.showMedicationInfoFrom,"necropsy-application-visibility":o(F).formSource!=="new",values:o(F)},null,8,["binding-cage-number","show-cell-line-info-from","show-medication-info-from","necropsy-application-visibility","values"]),e("div",Be,[V(e("button",{class:"btn btn-primary",type:"button",onClick:s[1]||(s[1]=(...I)=>o(E)&&o(E)(...I))}," 修改 ",512),[[U,l.value]]),V(e("button",{class:"btn btn-info text-white",type:"button",onClick:s[2]||(s[2]=(...I)=>o(P)&&o(P)(...I))}," 填寫完畢 ",512),[[U,!l.value]])])])]),_:1}),d.livingForms?.length?(h(),M(Z,{key:0,class:"mt-2"},{title:f(()=>[L(" 已填寫入室申請表 ")]),body:f(()=>[e("ul",Me,[(h(!0),S(x,null,G(d.livingForms,(I,$)=>(h(),S("li",{class:"nav-item",role:"presentation",key:I.id},[e("button",{class:z(["nav-link",{active:$===0}]),id:`homeTab${$}`,"data-bs-toggle":"tab","data-bs-target":`#tabPanel${$}`,type:"button",role:"tab","aria-controls":`tabPanel${$}`,"aria-selected":"true"}," #"+_($+1),11,Re)]))),128))]),e("div",Pe,[(h(!0),S(x,null,G(d.livingForms,(I,$)=>(h(),S("div",{class:z(["tab-pane p-2",{active:$===0}]),id:`tabPanel${$}`,role:"tabpanel","aria-labelledby":`homeTab${$}`,tabindex:$,key:I.id},[n(Ie,{livingForm:I},null,8,["livingForm"]),e("div",Qe,[e("button",{type:"button",class:"btn btn-secondary",onClick:Y(ie=>J($),["prevent"])}," 編輯 ",8,Ge),e("button",{type:"button",class:"btn btn-danger mx-1",onClick:Y(ie=>ee($),["prevent"])}," 刪除 ",8,Ze)])],10,Ue))),128))])]),_:1})):N("",!0),e("div",je,[V(e("button",{type:"button",class:"btn btn-primary",onClick:oe}," 下一步 ",512),[[U,d.livingForms?.length]])])])],64)}}}),Ye={class:"row mb-3"},qe=["for"],He={class:"col-8"},Ke={class:"row mb-3"},We=["for"],Xe={class:"col-8"},Je={class:"row mb-3"},eo=["for"],oo={class:"col-8"},lo={class:"row mb-3"},to=["for"],so={class:"col-8"},no={class:"row mb-3"},io=e("legend",{class:"col-form-label col-sm-2 pt-0 red-star"},"實驗類型",-1),ao={class:"col-sm-10"},ro={class:"row mb-3"},co=["for"],mo={class:"col-8"},po=e("i",{class:"bi bi-cloud-download"},null,-1),uo=[po],vo={id:"radiologyRelated"},fo={class:"row mb-3"},ho=["for"],bo={class:"col-8"},go={class:"row mb-3"},_o=["for"],yo={class:"col-8"},Fo={class:"row mb-3"},wo=["for"],So={class:"col-8"},Co={class:"row mb-3"},$o=["for"],ko={class:"col-8"},Lo={class:"row mb-3"},To=["for"],Io={class:"col-8"},Ao={id:"otherRelated"},No={class:"row mb-3"},xo=["for"],Eo={class:"col-8"},Do={class:"row mb-3"},Oo=["for"],Vo={class:"col-8"},Bo={class:"row mb-3"},Mo=["for"],Ro={class:"col-8"},Po={class:"row mb-3"},Uo=["for"],Qo={class:"col-8"},Go={class:"row mb-3"},Zo=["for"],jo={class:"col-8"},zo=R({__name:"NonLivingForm",props:{values:{},prefix:{default:()=>""}},setup(b){const c=b,{loggedInUser:i}=pe(ue()),a=l=>c.values.experimentType!==void 0&&c.values.experimentType.includes(l),u=B(()=>c.values.contact?c.values.contact:i.value?.title),y=B(()=>c.values.contactTel?c.values.contactTel:i.value?.phone),p=B(()=>c.values.contactEmail?c.values.contactEmail:i.value?.username),k=()=>{let r="data:text/csv;charset=utf-8,"+[["No.","Sample ID (只可填入14字元，包括空格及標點符號)"],["",""]].map(F=>F.join(",")).join(`
`);var v=encodeURI(r),g=document.createElement("a");g.setAttribute("href",v),g.setAttribute("download","sample.csv"),document.body.appendChild(g),g.click()};return(l,r)=>{const v=w("AppInput"),g=w("AppCheckbox"),F=w("AppDownloadFileInput"),T=w("AppBlock"),m=w("AppRadio"),C=w("AppRadioInput");return h(),S(x,null,[e("div",Ye,[e("label",{for:o(t)(l.prefix,"contact"),class:"col-sm-2 col-form-label red-star"},"申請者姓名",8,qe),e("div",He,[n(v,{name:o(t)(l.prefix,"contact"),value:u.value},null,8,["name","value"])])]),e("div",Ke,[e("label",{for:o(t)(l.prefix,"contactTel"),class:"col-sm-2 col-form-label red-star"},"申請者電話",8,We),e("div",Xe,[n(v,{name:o(t)(l.prefix,"contactTel"),value:y.value},null,8,["name","value"])])]),e("div",Je,[e("label",{for:o(t)(l.prefix,"contactEmail"),class:"col-sm-2 col-form-label red-star"},"申請者信箱",8,eo),e("div",oo,[n(v,{type:"email",name:o(t)(l.prefix,"contactEmail"),value:p.value},null,8,["name","value"])])]),e("div",lo,[e("label",{for:o(t)(l.prefix,"scheduledDeliveryDate"),class:"col-sm-2 col-form-label red-star"},"約定的送件日期",8,to),e("div",so,[n(v,{type:"date",name:o(t)(l.prefix,"scheduledDeliveryDate")},null,8,["name"])])]),e("fieldset",no,[io,e("div",ao,[n(g,{label:"病理學",name:o(t)(l.prefix,"experimentType"),id:o(t)(l.prefix,"experimentTypePathology"),"checked-value":"pathology"},null,8,["name","id"]),n(g,{label:"斷層掃描",name:o(t)(l.prefix,"experimentType"),id:o(t)(l.prefix,"experimentTypeRadiology"),"checked-value":"radiology"},null,8,["name","id"]),n(g,{label:"其它",name:o(t)(l.prefix,"experimentType"),id:o(t)(l.prefix,"experimentTypeOther"),"checked-value":"other"},null,8,["name","id"])])]),a("pathology")?(h(),M(T,{key:0,class:"my-2"},{title:f(()=>[L(" 病理學 ")]),content:f(()=>[e("div",ro,[e("label",{for:o(t)(l.prefix,"uploadedSampleSheetFile"),class:"col-sm-2 col-form-label red-star"},"上傳檢體編號表",8,co),e("div",mo,[n(F,{name:o(t)(l.prefix,"uploadedSampleSheetFile"),schema:o(_e)},null,8,["name","schema"]),e("div",null,[L(" 檢體編號表範本"),e("a",{href:"#",onClick:k},uo)])])]),n(he,{prefix:l.prefix,values:l.values,visible:a("pathology")},null,8,["prefix","values","visible"])]),_:1})):N("",!0),a("radiology")?(h(),M(T,{key:1,class:"my-2"},{title:f(()=>[L(" 影像學 ")]),content:f(()=>[e("div",vo,[e("div",fo,[e("label",{for:o(t)(l.prefix,"radiology.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,ho),e("div",bo,[n(v,{id:o(t)(l.prefix,"radiology.sampleNumber"),type:"number",name:o(t)(l.prefix,"radiology.sampleNumber")},null,8,["id","name"])])]),e("div",go,[e("label",{for:o(t)(l.prefix,"radiology.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,_o),e("div",yo,[n(v,{type:"text",id:o(t)(l.prefix,"radiology.sampleId"),name:o(t)(l.prefix,"radiology.sampleId")},null,8,["id","name"])])]),e("div",Fo,[e("label",{for:o(t)(l.prefix,"radiology.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,wo),e("div",So,[n(m,{name:o(t)(l.prefix,"radiology.sampleType"),id:o(t)(l.prefix,"radiology.sampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),n(C,{label:"其他",id:o(t)(l.prefix,"radiologyOtherSampleType"),"radio-name":o(t)(l.prefix,"radiology.sampleType"),"checked-value":"other","input-name":o(t)(l.prefix,"radiology.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",Co,[e("label",{for:o(t)(l.prefix,"radiology.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,$o),e("div",ko,[n(F,{name:o(t)(l.prefix,"radiology.attachment")},null,8,["name"])])]),e("div",Lo,[e("label",{for:o(t)(l.prefix,"radiology.note"),class:"col-sm-2 col-form-label"},"備註",8,To),e("div",Io,[n(v,{type:"text",id:o(t)(l.prefix,"radiology.note"),name:o(t)(l.prefix,"radiology.note")},null,8,["id","name"])])])])]),_:1})):N("",!0),a("other")?(h(),M(T,{key:2,class:"my-2"},{title:f(()=>[L(" 其他 ")]),content:f(()=>[e("div",Ao,[e("div",No,[e("label",{for:o(t)(l.prefix,"other.sampleNumber"),class:"col-sm-2 col-form-label red-star"},"樣品數量",8,xo),e("div",Eo,[n(v,{id:o(t)(l.prefix,"other.sampleNumber"),type:"number",name:o(t)(l.prefix,"other.sampleNumber")},null,8,["id","name"])])]),e("div",Do,[e("label",{for:o(t)(l.prefix,"other.sampleId"),class:"col-sm-2 col-form-label red-star"},"樣品ID",8,Oo),e("div",Vo,[n(v,{type:"text",id:o(t)(l.prefix,"other.sampleId"),name:o(t)(l.prefix,"other.sampleId")},null,8,["id","name"])])]),e("div",Bo,[e("label",{for:o(t)(l.prefix,"other.sampleTypeAnimal"),class:"col-sm-2 col-form-label red-star"},"樣品類型",8,Mo),e("div",Ro,[n(m,{name:o(t)(l.prefix,"other.sampleType"),id:o(t)(l.prefix,"otherSampleTypeAnimal"),label:"動物","checked-value":"animal"},null,8,["name","id"]),n(C,{label:"其他",id:o(t)(l.prefix,"otherOtherSampleType"),"radio-name":o(t)(l.prefix,"other.sampleType"),"checked-value":"other","input-name":o(t)(l.prefix,"other.otherSampleTypeInput")},null,8,["id","radio-name","input-name"])])]),e("div",Po,[e("label",{for:o(t)(l.prefix,"other.attachment"),class:"col-sm-2 col-form-label"},"相關附件上傳",8,Uo),e("div",Qo,[n(F,{name:o(t)(l.prefix,"other.attachment")},null,8,["name"])])]),e("div",Go,[e("label",{for:o(t)(l.prefix,"other.note"),class:"col-sm-2 col-form-label"},"備註",8,Zo),e("div",jo,[n(v,{type:"text",id:o(t)(l.prefix,"other.note"),name:o(t)(l.prefix,"other.note")},null,8,["id","name"])])])])]),_:1})):N("",!0)],64)}}}),Yo=e("h5",{class:"mb-0"},"填寫非活體資料",-1),qo=e("div",{class:"mb-2 d-flex justify-content-between flex-row-reverse mt-2"},[e("button",{type:"submit",class:"btn btn-primary"},"下一步")],-1),Ho=R({__name:"NonLivingFormEditingZone",props:{nonLivingForm:{}},emits:["saveNonLivingForm"],setup(b,{emit:c}){const i=b,a=c,{handleSubmit:u,values:y,errors:p}=W({initialValues:i.nonLivingForm,validationSchema:ye});X("errors",p);const k=u(r=>{r.experimentType?.includes("pathology")?(r.pathologicalExpType?.includes("TissueSection")||delete r.tissueSection,r.pathologicalExpType?.includes("ihc")||delete r.ihc,r.pathologicalExpType?.includes("Blood")||delete r.blood):(delete r.blood,delete r.tissueSection,delete r.ihc,delete r.slideScanning,delete r.histopathology),a("saveNonLivingForm",Q(r))}),l=B(()=>{const r=Object.keys(p.value).length;return r!==0?`尚有${r}個項目未填寫`:""});return(r,v)=>{const g=w("AppFloatingMessage"),F=w("AppCard");return h(),S(x,null,[n(g,{message:l.value},null,8,["message"]),e("form",{id:"nonLivingFormEditingZone",onSubmit:v[0]||(v[0]=(...T)=>o(k)&&o(k)(...T)),class:"mt-4"},[n(F,{class:"mt-4"},{header:f(()=>[Yo]),body:f(()=>[n(zo,{values:o(y)},null,8,["values"])]),_:1}),qo],32)],64)}}}),Ko=e("h4",{class:"fw-bold py-3 mb-4"},"實驗類型",-1),Wo=e("h5",{class:"mb-0"},"活體/非活體",-1),Xo={class:"form-check form-check-inline"},Jo=["value"],el={class:"form-check-label",for:"living"},ol={class:"form-check form-check-inline"},ll=["value"],tl={class:"form-check-label",for:"nonLiving"},ml=R({__name:"ExpApplicationStep2",props:{id:{}},setup(b){console.log("step2");const c=b,i=K(),a=A(),u=A(),y=A(),p=A(!1),k=A(!1),l=A(!1);ve(async()=>{await i.loadDataForStep2(c.id).then(m=>{a.value=m?.sampleCategory,u.value=m?.livingForms===void 0?[]:m.livingForms,y.value=m?.nonLivingForm,p.value=m?.bindingCageNumber,k.value=m?.showCellLineInfoFrom||!1,l.value=m?.showMedicationInfoFrom||!1}).catch(m=>{console.log(m)})});const r=async()=>{a.value&&u.value&&await i.saveLivingForms(c.id,a.value,u.value).then(()=>{i.proceedToStep3(c.id)})},v=m=>{u.value===void 0&&(u.value=[]),u.value.push(m)},g=m=>{u.value===void 0&&(u.value=[]),u.value[m.index]=m.form},F=m=>{u.value&&u.value.splice(m,1)},T=async m=>{a.value&&await i.saveNonLivingForm(c.id,a.value,m).then(()=>{i.proceedToStep3(c.id)})};return(m,C)=>{const P=w("AppCard");return h(),S(x,null,[Ko,n(P,null,{header:f(()=>[Wo]),body:f(()=>[e("div",Xo,[V(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:o(D).LIVING,id:"living","onUpdate:modelValue":C[0]||(C[0]=E=>a.value=E)},null,8,Jo),[[q,a.value]]),e("label",el,_(o(H)(o(D).LIVING)),1)]),e("div",ol,[V(e("input",{name:"sampleCategory",class:"form-check-input",type:"radio",value:o(D).NON_LIVING,id:"nonLiving","onUpdate:modelValue":C[1]||(C[1]=E=>a.value=E)},null,8,ll),[[q,a.value]]),e("label",tl,_(o(H)(o(D).NON_LIVING)),1)])]),_:1}),a.value===o(D).LIVING?(h(),M(ze,{key:0,"binding-cage-number":p.value,"living-forms":u.value?u.value:[],"show-medication-info-from":l.value,"show-cell-line-info-from":k.value,onSaveLivingForm:r,onAddLivingForm:v,onUpdateLivingForm:g,onDeleteForm:F},null,8,["binding-cage-number","living-forms","show-medication-info-from","show-cell-line-info-from"])):N("",!0),a.value===o(D).NON_LIVING?(h(),M(Ho,{key:1,"non-living-form":y.value,onSaveNonLivingForm:T},null,8,["non-living-form"])):N("",!0)],64)}}});export{ml as default};
